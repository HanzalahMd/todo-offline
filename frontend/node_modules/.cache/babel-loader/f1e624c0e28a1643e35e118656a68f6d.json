{"ast":null,"code":"import _regeneratorRuntime from \"@babel/runtime/regenerator\";\nimport _asyncToGenerator from \"@babel/runtime/helpers/asyncToGenerator\";\nimport objectPath from 'object-path';\nimport { BehaviorSubject } from 'rxjs';\nimport { distinctUntilChanged, map } from 'rxjs/operators';\nimport { clone, trimDots, getHeightOfRevision, pluginMissing, now, nextTick } from './util';\nimport { createUpdateEvent, createDeleteEvent } from './rx-change-event';\nimport { newRxError, newRxTypeError, isPouchdbConflictError } from './rx-error';\nimport { runPluginHooks } from './hooks';\nexport var basePrototype = {\n  /**\n   * TODO\n   * instead of appliying the _this-hack\n   * we should make these accesors functions instead of getters.\n   */\n  get _data() {\n    var _this = this;\n    /**\n     * Might be undefined when vuejs-devtools are used\n     * @link https://github.com/pubkey/rxdb/issues/1126\n     */\n\n\n    if (!_this.isInstanceOfRxDocument) {\n      return undefined;\n    }\n\n    return _this._dataSync$.getValue();\n  },\n\n  get primaryPath() {\n    var _this = this;\n\n    if (!_this.isInstanceOfRxDocument) {\n      return undefined;\n    }\n\n    return _this.collection.schema.primaryPath;\n  },\n\n  get primary() {\n    var _this = this;\n\n    if (!_this.isInstanceOfRxDocument) {\n      return undefined;\n    }\n\n    return _this._data[_this.primaryPath];\n  },\n\n  get revision() {\n    var _this = this;\n\n    if (!_this.isInstanceOfRxDocument) {\n      return undefined;\n    }\n\n    return _this._data._rev;\n  },\n\n  get deleted$() {\n    var _this = this;\n\n    if (!_this.isInstanceOfRxDocument) {\n      return undefined;\n    }\n\n    return _this._deleted$.asObservable();\n  },\n\n  get deleted() {\n    var _this = this;\n\n    if (!_this.isInstanceOfRxDocument) {\n      return undefined;\n    }\n\n    return _this._deleted$.getValue();\n  },\n\n  /**\n   * returns the observable which emits the plain-data of this document\n   */\n  get $() {\n    var _this = this;\n\n    return _this._dataSync$.asObservable();\n  },\n\n  _handleChangeEvent: function _handleChangeEvent(changeEvent) {\n    if (changeEvent.documentId !== this.primary) return; // ensure that new _rev is higher then current\n\n    var newRevNr = getHeightOfRevision(changeEvent.documentData._rev);\n    var currentRevNr = getHeightOfRevision(this._data._rev);\n    if (currentRevNr > newRevNr) return;\n\n    switch (changeEvent.operation) {\n      case 'INSERT':\n        break;\n\n      case 'UPDATE':\n        var newData = changeEvent.documentData;\n\n        this._dataSync$.next(newData);\n\n        break;\n\n      case 'DELETE':\n        // remove from docCache to assure new upserted RxDocuments will be a new instance\n        this.collection._docCache[\"delete\"](this.primary);\n\n        this._deleted$.next(true);\n\n        break;\n    }\n  },\n\n  /**\n   * emits the changeEvent to the upper instance (RxCollection)\n   */\n  $emit: function $emit(changeEvent) {\n    return this.collection.$emit(changeEvent);\n  },\n\n  /**\n   * returns observable of the value of the given path\n   */\n  get$: function get$(path) {\n    if (path.includes('.item.')) {\n      throw newRxError('DOC1', {\n        path: path\n      });\n    }\n\n    if (path === this.primaryPath) throw newRxError('DOC2'); // final fields cannot be modified and so also not observed\n\n    if (this.collection.schema.finalFields.includes(path)) {\n      throw newRxError('DOC3', {\n        path: path\n      });\n    }\n\n    var schemaObj = this.collection.schema.getSchemaByObjectPath(path);\n\n    if (!schemaObj) {\n      throw newRxError('DOC4', {\n        path: path\n      });\n    }\n\n    return this._dataSync$.pipe(map(function (data) {\n      return objectPath.get(data, path);\n    }), distinctUntilChanged());\n  },\n\n  /**\n   * populate the given path\n   */\n  populate: function populate(path) {\n    var schemaObj = this.collection.schema.getSchemaByObjectPath(path);\n    var value = this.get(path);\n\n    if (!value) {\n      return Promise.resolve(null);\n    }\n\n    if (!schemaObj) {\n      throw newRxError('DOC5', {\n        path: path\n      });\n    }\n\n    if (!schemaObj.ref) {\n      throw newRxError('DOC6', {\n        path: path,\n        schemaObj: schemaObj\n      });\n    }\n\n    var refCollection = this.collection.database.collections[schemaObj.ref];\n\n    if (!refCollection) {\n      throw newRxError('DOC7', {\n        ref: schemaObj.ref,\n        path: path,\n        schemaObj: schemaObj\n      });\n    }\n\n    if (schemaObj.type === 'array') {\n      return refCollection.findByIds(value).then(function (res) {\n        var valuesIterator = res.values();\n        return Array.from(valuesIterator);\n      });\n    } else {\n      return refCollection.findOne(value).exec();\n    }\n  },\n\n  /**\n   * get data by objectPath\n   */\n  get: function get(objPath) {\n    if (!this._data) return undefined;\n    var valueObj = objectPath.get(this._data, objPath);\n    valueObj = clone(valueObj); // direct return if array or non-object\n\n    if (typeof valueObj !== 'object' || Array.isArray(valueObj)) return valueObj;\n    defineGetterSetter(this.collection.schema, valueObj, objPath, this);\n    return valueObj;\n  },\n  toJSON: function toJSON() {\n    var withRevAndAttachments = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : false;\n    var data = clone(this._data);\n\n    if (!withRevAndAttachments) {\n      delete data._rev;\n      delete data._attachments;\n    }\n\n    return data;\n  },\n\n  /**\n   * set data by objectPath\n   * This can only be called on temporary documents\n   */\n  set: function set(objPath, value) {\n    // setters can only be used on temporary documents\n    if (!this._isTemporary) {\n      throw newRxTypeError('DOC16', {\n        objPath: objPath,\n        value: value\n      });\n    }\n\n    if (typeof objPath !== 'string') {\n      throw newRxTypeError('DOC15', {\n        objPath: objPath,\n        value: value\n      });\n    } // if equal, do nothing\n\n\n    if (Object.is(this.get(objPath), value)) return; // throw if nested without root-object\n\n    var pathEls = objPath.split('.');\n    pathEls.pop();\n    var rootPath = pathEls.join('.');\n\n    if (typeof objectPath.get(this._data, rootPath) === 'undefined') {\n      throw newRxError('DOC10', {\n        childpath: objPath,\n        rootPath: rootPath\n      });\n    }\n\n    objectPath.set(this._data, objPath, value);\n    return this;\n  },\n\n  /**\n   * updates document\n   * @overwritten by plugin (optinal)\n   * @param updateObj mongodb-like syntax\n   */\n  update: function update(_updateObj) {\n    throw pluginMissing('update');\n  },\n  putAttachment: function putAttachment() {\n    throw pluginMissing('attachments');\n  },\n  getAttachment: function getAttachment() {\n    throw pluginMissing('attachments');\n  },\n  allAttachments: function allAttachments() {\n    throw pluginMissing('attachments');\n  },\n\n  get allAttachments$() {\n    throw pluginMissing('attachments');\n  },\n\n  /**\n   * runs an atomic update over the document\n   * @param function that takes the document-data and returns a new data-object\n   */\n  atomicUpdate: function atomicUpdate(mutationFunction) {\n    var _this2 = this;\n\n    return new Promise(function (res, rej) {\n      _this2._atomicQueue = _this2._atomicQueue.then(\n      /*#__PURE__*/\n      _asyncToGenerator(\n      /*#__PURE__*/\n      _regeneratorRuntime.mark(function _callee() {\n        var done, oldData, newData;\n        return _regeneratorRuntime.wrap(function _callee$(_context) {\n          while (1) {\n            switch (_context.prev = _context.next) {\n              case 0:\n                done = false;\n              // we need a hacky while loop to stay incide the chain-link of _atomicQueue\n              // while still having the option to run a retry on conflicts\n\n              case 1:\n                if (done) {\n                  _context.next = 24;\n                  break;\n                }\n\n                oldData = _this2._dataSync$.getValue();\n                _context.prev = 3;\n                _context.next = 6;\n                return mutationFunction(clone(_this2._dataSync$.getValue()), _this2);\n\n              case 6:\n                newData = _context.sent;\n\n                if (_this2.collection) {\n                  newData = _this2.collection.schema.fillObjectWithDefaults(newData);\n                }\n\n                _context.next = 10;\n                return _this2._saveData(newData, oldData);\n\n              case 10:\n                done = true;\n                _context.next = 22;\n                break;\n\n              case 13:\n                _context.prev = 13;\n                _context.t0 = _context[\"catch\"](3);\n\n                if (!isPouchdbConflictError(_context.t0)) {\n                  _context.next = 20;\n                  break;\n                }\n\n                _context.next = 18;\n                return nextTick();\n\n              case 18:\n                _context.next = 22;\n                break;\n\n              case 20:\n                rej(_context.t0);\n                return _context.abrupt(\"return\");\n\n              case 22:\n                _context.next = 1;\n                break;\n\n              case 24:\n                res(_this2);\n\n              case 25:\n              case \"end\":\n                return _context.stop();\n            }\n          }\n        }, _callee, null, [[3, 13]]);\n      })));\n    });\n  },\n\n  /**\n   * patches the given properties\n   */\n  atomicPatch: function atomicPatch(patch) {\n    return this.atomicUpdate(function (docData) {\n      Object.entries(patch).forEach(function (_ref2) {\n        var k = _ref2[0],\n            v = _ref2[1];\n        docData[k] = v;\n      });\n      return docData;\n    });\n  },\n\n  /**\n   * @deprecated use atomicPatch instead because it is better typed\n   * and does not allow any keys and values\n   */\n  atomicSet: function atomicSet(key, value) {\n    return this.atomicUpdate(function (docData) {\n      objectPath.set(docData, key, value);\n      return docData;\n    });\n  },\n\n  /**\n   * saves the new document-data\n   * and handles the events\n   */\n  _saveData: function _saveData(newData, oldData) {\n    var _this3 = this;\n\n    newData = newData; // deleted documents cannot be changed\n\n    if (this._deleted$.getValue()) {\n      throw newRxError('DOC11', {\n        id: this.primary,\n        document: this\n      });\n    } // ensure modifications are ok\n\n\n    this.collection.schema.validateChange(oldData, newData);\n    var startTime;\n    return this.collection._runHooks('pre', 'save', newData, this).then(function () {\n      _this3.collection.schema.validate(newData);\n\n      startTime = now();\n      return _this3.collection._pouchPut(newData);\n    }).then(function (ret) {\n      var endTime = now();\n\n      if (!ret.ok) {\n        throw newRxError('DOC12', {\n          data: ret\n        });\n      }\n\n      newData._rev = ret.rev; // emit event\n\n      var changeEvent = createUpdateEvent(_this3.collection, newData, oldData, startTime, endTime, _this3);\n\n      _this3.$emit(changeEvent);\n\n      return _this3.collection._runHooks('post', 'save', newData, _this3);\n    });\n  },\n\n  /**\n   * saves the temporary document and makes a non-temporary out of it\n   * Saving a temporary doc is basically the same as RxCollection.insert()\n   * @return false if nothing to save\n   */\n  save: function save() {\n    var _this4 = this; // .save() cannot be called on non-temporary-documents\n\n\n    if (!this._isTemporary) {\n      throw newRxError('DOC17', {\n        id: this.primary,\n        document: this\n      });\n    }\n\n    return this.collection.insert(this).then(function () {\n      _this4._isTemporary = false;\n\n      _this4.collection._docCache.set(_this4.primary, _this4); // internal events\n\n\n      _this4._dataSync$.next(_this4._data);\n\n      return true;\n    });\n  },\n\n  /**\n   * remove the document,\n   * this not not equal to a pouchdb.remove(),\n   * instead we keep the values and only set _deleted: true\n   */\n  remove: function remove() {\n    var _this5 = this;\n\n    if (this.deleted) {\n      return Promise.reject(newRxError('DOC13', {\n        document: this,\n        id: this.primary\n      }));\n    }\n\n    var deletedData = clone(this._data);\n    var startTime;\n    return this.collection._runHooks('pre', 'remove', deletedData, this).then(function () {\n      deletedData._deleted = true;\n      startTime = now();\n      /**\n       * because pouch.remove will also empty the object,\n       * we set _deleted: true and use pouch.put\n       */\n\n      return _this5.collection._pouchPut(deletedData);\n    }).then(function () {\n      var endTime = now();\n\n      _this5.$emit(createDeleteEvent(_this5.collection, deletedData, _this5._data, startTime, endTime, _this5));\n\n      return _this5.collection._runHooks('post', 'remove', deletedData, _this5);\n    }).then(function () {\n      return _this5;\n    });\n  },\n  destroy: function destroy() {\n    throw newRxError('DOC14');\n  }\n};\nexport function createRxDocumentConstructor() {\n  var proto = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : basePrototype;\n\n  var constructor = function RxDocumentConstructor(collection, jsonData) {\n    this.collection = collection; // if true, this is a temporary document\n\n    this._isTemporary = false; // assume that this is always equal to the doc-data in the database\n\n    this._dataSync$ = new BehaviorSubject(jsonData);\n    this._deleted$ = new BehaviorSubject(false);\n    this._atomicQueue = Promise.resolve();\n    /**\n     * because of the prototype-merge,\n     * we can not use the native instanceof operator\n     */\n\n    this.isInstanceOfRxDocument = true;\n  };\n\n  constructor.prototype = proto;\n  return constructor;\n}\nexport function defineGetterSetter(schema, valueObj) {\n  var objPath = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : '';\n  var thisObj = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : false;\n  if (valueObj === null) return;\n  var pathProperties = schema.getSchemaByObjectPath(objPath);\n  if (typeof pathProperties === 'undefined') return;\n  if (pathProperties.properties) pathProperties = pathProperties.properties;\n  Object.keys(pathProperties).forEach(function (key) {\n    var fullPath = trimDots(objPath + '.' + key); // getter - value\n\n    valueObj.__defineGetter__(key, function () {\n      var _this = thisObj ? thisObj : this;\n\n      if (!_this.get || typeof _this.get !== 'function') {\n        /**\n         * When an object gets added to the state of a vuejs-component,\n         * it happens that this getter is called with another scope.\n         * To prevent errors, we have to return undefined in this case\n         */\n        return undefined;\n      }\n\n      var ret = _this.get(fullPath);\n\n      return ret;\n    }); // getter - observable$\n\n\n    Object.defineProperty(valueObj, key + '$', {\n      get: function get() {\n        var _this = thisObj ? thisObj : this;\n\n        return _this.get$(fullPath);\n      },\n      enumerable: false,\n      configurable: false\n    }); // getter - populate_\n\n    Object.defineProperty(valueObj, key + '_', {\n      get: function get() {\n        var _this = thisObj ? thisObj : this;\n\n        return _this.populate(fullPath);\n      },\n      enumerable: false,\n      configurable: false\n    }); // setter - value\n\n    valueObj.__defineSetter__(key, function (val) {\n      var _this = thisObj ? thisObj : this;\n\n      return _this.set(fullPath, val);\n    });\n  });\n}\nexport function createWithConstructor(constructor, collection, jsonData) {\n  if (jsonData[collection.schema.primaryPath] && jsonData[collection.schema.primaryPath].startsWith('_design')) return null;\n  var doc = new constructor(collection, jsonData);\n  runPluginHooks('createRxDocument', doc);\n  return doc;\n}\nexport function isInstanceOf(obj) {\n  if (typeof obj === 'undefined') return false;\n  return !!obj.isInstanceOfRxDocument;\n}","map":{"version":3,"sources":["/Users/Hanzalah/Desktop/github/todo-offline/rxdb-hasura-demo/node_modules/rxdb/dist/es/rx-document.js"],"names":["_regeneratorRuntime","_asyncToGenerator","objectPath","BehaviorSubject","distinctUntilChanged","map","clone","trimDots","getHeightOfRevision","pluginMissing","now","nextTick","createUpdateEvent","createDeleteEvent","newRxError","newRxTypeError","isPouchdbConflictError","runPluginHooks","basePrototype","_data","_this","isInstanceOfRxDocument","undefined","_dataSync$","getValue","primaryPath","collection","schema","primary","revision","_rev","deleted$","_deleted$","asObservable","deleted","$","_handleChangeEvent","changeEvent","documentId","newRevNr","documentData","currentRevNr","operation","newData","next","_docCache","$emit","get$","path","includes","finalFields","schemaObj","getSchemaByObjectPath","pipe","data","get","populate","value","Promise","resolve","ref","refCollection","database","collections","type","findByIds","then","res","valuesIterator","values","Array","from","findOne","exec","objPath","valueObj","isArray","defineGetterSetter","toJSON","withRevAndAttachments","arguments","length","_attachments","set","_isTemporary","Object","is","pathEls","split","pop","rootPath","join","childpath","update","_updateObj","putAttachment","getAttachment","allAttachments","allAttachments$","atomicUpdate","mutationFunction","_this2","rej","_atomicQueue","mark","_callee","done","oldData","wrap","_callee$","_context","prev","sent","fillObjectWithDefaults","_saveData","t0","abrupt","stop","atomicPatch","patch","docData","entries","forEach","_ref2","k","v","atomicSet","key","_this3","id","document","validateChange","startTime","_runHooks","validate","_pouchPut","ret","endTime","ok","rev","save","_this4","insert","remove","_this5","reject","deletedData","_deleted","destroy","createRxDocumentConstructor","proto","constructor","RxDocumentConstructor","jsonData","prototype","thisObj","pathProperties","properties","keys","fullPath","__defineGetter__","defineProperty","enumerable","configurable","__defineSetter__","val","createWithConstructor","startsWith","doc","isInstanceOf","obj"],"mappings":"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","sourcesContent":["import _regeneratorRuntime from \"@babel/runtime/regenerator\";\nimport _asyncToGenerator from \"@babel/runtime/helpers/asyncToGenerator\";\nimport objectPath from 'object-path';\nimport { BehaviorSubject } from 'rxjs';\nimport { distinctUntilChanged, map } from 'rxjs/operators';\nimport { clone, trimDots, getHeightOfRevision, pluginMissing, now, nextTick } from './util';\nimport { createUpdateEvent, createDeleteEvent } from './rx-change-event';\nimport { newRxError, newRxTypeError, isPouchdbConflictError } from './rx-error';\nimport { runPluginHooks } from './hooks';\nexport var basePrototype = {\n  /**\n   * TODO\n   * instead of appliying the _this-hack\n   * we should make these accesors functions instead of getters.\n   */\n  get _data() {\n    var _this = this;\n    /**\n     * Might be undefined when vuejs-devtools are used\n     * @link https://github.com/pubkey/rxdb/issues/1126\n     */\n\n\n    if (!_this.isInstanceOfRxDocument) {\n      return undefined;\n    }\n\n    return _this._dataSync$.getValue();\n  },\n\n  get primaryPath() {\n    var _this = this;\n\n    if (!_this.isInstanceOfRxDocument) {\n      return undefined;\n    }\n\n    return _this.collection.schema.primaryPath;\n  },\n\n  get primary() {\n    var _this = this;\n\n    if (!_this.isInstanceOfRxDocument) {\n      return undefined;\n    }\n\n    return _this._data[_this.primaryPath];\n  },\n\n  get revision() {\n    var _this = this;\n\n    if (!_this.isInstanceOfRxDocument) {\n      return undefined;\n    }\n\n    return _this._data._rev;\n  },\n\n  get deleted$() {\n    var _this = this;\n\n    if (!_this.isInstanceOfRxDocument) {\n      return undefined;\n    }\n\n    return _this._deleted$.asObservable();\n  },\n\n  get deleted() {\n    var _this = this;\n\n    if (!_this.isInstanceOfRxDocument) {\n      return undefined;\n    }\n\n    return _this._deleted$.getValue();\n  },\n\n  /**\n   * returns the observable which emits the plain-data of this document\n   */\n  get $() {\n    var _this = this;\n\n    return _this._dataSync$.asObservable();\n  },\n\n  _handleChangeEvent: function _handleChangeEvent(changeEvent) {\n    if (changeEvent.documentId !== this.primary) return; // ensure that new _rev is higher then current\n\n    var newRevNr = getHeightOfRevision(changeEvent.documentData._rev);\n    var currentRevNr = getHeightOfRevision(this._data._rev);\n    if (currentRevNr > newRevNr) return;\n\n    switch (changeEvent.operation) {\n      case 'INSERT':\n        break;\n\n      case 'UPDATE':\n        var newData = changeEvent.documentData;\n\n        this._dataSync$.next(newData);\n\n        break;\n\n      case 'DELETE':\n        // remove from docCache to assure new upserted RxDocuments will be a new instance\n        this.collection._docCache[\"delete\"](this.primary);\n\n        this._deleted$.next(true);\n\n        break;\n    }\n  },\n\n  /**\n   * emits the changeEvent to the upper instance (RxCollection)\n   */\n  $emit: function $emit(changeEvent) {\n    return this.collection.$emit(changeEvent);\n  },\n\n  /**\n   * returns observable of the value of the given path\n   */\n  get$: function get$(path) {\n    if (path.includes('.item.')) {\n      throw newRxError('DOC1', {\n        path: path\n      });\n    }\n\n    if (path === this.primaryPath) throw newRxError('DOC2'); // final fields cannot be modified and so also not observed\n\n    if (this.collection.schema.finalFields.includes(path)) {\n      throw newRxError('DOC3', {\n        path: path\n      });\n    }\n\n    var schemaObj = this.collection.schema.getSchemaByObjectPath(path);\n\n    if (!schemaObj) {\n      throw newRxError('DOC4', {\n        path: path\n      });\n    }\n\n    return this._dataSync$.pipe(map(function (data) {\n      return objectPath.get(data, path);\n    }), distinctUntilChanged());\n  },\n\n  /**\n   * populate the given path\n   */\n  populate: function populate(path) {\n    var schemaObj = this.collection.schema.getSchemaByObjectPath(path);\n    var value = this.get(path);\n\n    if (!value) {\n      return Promise.resolve(null);\n    }\n\n    if (!schemaObj) {\n      throw newRxError('DOC5', {\n        path: path\n      });\n    }\n\n    if (!schemaObj.ref) {\n      throw newRxError('DOC6', {\n        path: path,\n        schemaObj: schemaObj\n      });\n    }\n\n    var refCollection = this.collection.database.collections[schemaObj.ref];\n\n    if (!refCollection) {\n      throw newRxError('DOC7', {\n        ref: schemaObj.ref,\n        path: path,\n        schemaObj: schemaObj\n      });\n    }\n\n    if (schemaObj.type === 'array') {\n      return refCollection.findByIds(value).then(function (res) {\n        var valuesIterator = res.values();\n        return Array.from(valuesIterator);\n      });\n    } else {\n      return refCollection.findOne(value).exec();\n    }\n  },\n\n  /**\n   * get data by objectPath\n   */\n  get: function get(objPath) {\n    if (!this._data) return undefined;\n    var valueObj = objectPath.get(this._data, objPath);\n    valueObj = clone(valueObj); // direct return if array or non-object\n\n    if (typeof valueObj !== 'object' || Array.isArray(valueObj)) return valueObj;\n    defineGetterSetter(this.collection.schema, valueObj, objPath, this);\n    return valueObj;\n  },\n  toJSON: function toJSON() {\n    var withRevAndAttachments = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : false;\n    var data = clone(this._data);\n\n    if (!withRevAndAttachments) {\n      delete data._rev;\n      delete data._attachments;\n    }\n\n    return data;\n  },\n\n  /**\n   * set data by objectPath\n   * This can only be called on temporary documents\n   */\n  set: function set(objPath, value) {\n    // setters can only be used on temporary documents\n    if (!this._isTemporary) {\n      throw newRxTypeError('DOC16', {\n        objPath: objPath,\n        value: value\n      });\n    }\n\n    if (typeof objPath !== 'string') {\n      throw newRxTypeError('DOC15', {\n        objPath: objPath,\n        value: value\n      });\n    } // if equal, do nothing\n\n\n    if (Object.is(this.get(objPath), value)) return; // throw if nested without root-object\n\n    var pathEls = objPath.split('.');\n    pathEls.pop();\n    var rootPath = pathEls.join('.');\n\n    if (typeof objectPath.get(this._data, rootPath) === 'undefined') {\n      throw newRxError('DOC10', {\n        childpath: objPath,\n        rootPath: rootPath\n      });\n    }\n\n    objectPath.set(this._data, objPath, value);\n    return this;\n  },\n\n  /**\n   * updates document\n   * @overwritten by plugin (optinal)\n   * @param updateObj mongodb-like syntax\n   */\n  update: function update(_updateObj) {\n    throw pluginMissing('update');\n  },\n  putAttachment: function putAttachment() {\n    throw pluginMissing('attachments');\n  },\n  getAttachment: function getAttachment() {\n    throw pluginMissing('attachments');\n  },\n  allAttachments: function allAttachments() {\n    throw pluginMissing('attachments');\n  },\n\n  get allAttachments$() {\n    throw pluginMissing('attachments');\n  },\n\n  /**\n   * runs an atomic update over the document\n   * @param function that takes the document-data and returns a new data-object\n   */\n  atomicUpdate: function atomicUpdate(mutationFunction) {\n    var _this2 = this;\n\n    return new Promise(function (res, rej) {\n      _this2._atomicQueue = _this2._atomicQueue.then( /*#__PURE__*/_asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee() {\n        var done, oldData, newData;\n        return _regeneratorRuntime.wrap(function _callee$(_context) {\n          while (1) {\n            switch (_context.prev = _context.next) {\n              case 0:\n                done = false; // we need a hacky while loop to stay incide the chain-link of _atomicQueue\n                // while still having the option to run a retry on conflicts\n\n              case 1:\n                if (done) {\n                  _context.next = 24;\n                  break;\n                }\n\n                oldData = _this2._dataSync$.getValue();\n                _context.prev = 3;\n                _context.next = 6;\n                return mutationFunction(clone(_this2._dataSync$.getValue()), _this2);\n\n              case 6:\n                newData = _context.sent;\n\n                if (_this2.collection) {\n                  newData = _this2.collection.schema.fillObjectWithDefaults(newData);\n                }\n\n                _context.next = 10;\n                return _this2._saveData(newData, oldData);\n\n              case 10:\n                done = true;\n                _context.next = 22;\n                break;\n\n              case 13:\n                _context.prev = 13;\n                _context.t0 = _context[\"catch\"](3);\n\n                if (!isPouchdbConflictError(_context.t0)) {\n                  _context.next = 20;\n                  break;\n                }\n\n                _context.next = 18;\n                return nextTick();\n\n              case 18:\n                _context.next = 22;\n                break;\n\n              case 20:\n                rej(_context.t0);\n                return _context.abrupt(\"return\");\n\n              case 22:\n                _context.next = 1;\n                break;\n\n              case 24:\n                res(_this2);\n\n              case 25:\n              case \"end\":\n                return _context.stop();\n            }\n          }\n        }, _callee, null, [[3, 13]]);\n      })));\n    });\n  },\n\n  /**\n   * patches the given properties\n   */\n  atomicPatch: function atomicPatch(patch) {\n    return this.atomicUpdate(function (docData) {\n      Object.entries(patch).forEach(function (_ref2) {\n        var k = _ref2[0],\n            v = _ref2[1];\n        docData[k] = v;\n      });\n      return docData;\n    });\n  },\n\n  /**\n   * @deprecated use atomicPatch instead because it is better typed\n   * and does not allow any keys and values\n   */\n  atomicSet: function atomicSet(key, value) {\n    return this.atomicUpdate(function (docData) {\n      objectPath.set(docData, key, value);\n      return docData;\n    });\n  },\n\n  /**\n   * saves the new document-data\n   * and handles the events\n   */\n  _saveData: function _saveData(newData, oldData) {\n    var _this3 = this;\n\n    newData = newData; // deleted documents cannot be changed\n\n    if (this._deleted$.getValue()) {\n      throw newRxError('DOC11', {\n        id: this.primary,\n        document: this\n      });\n    } // ensure modifications are ok\n\n\n    this.collection.schema.validateChange(oldData, newData);\n    var startTime;\n    return this.collection._runHooks('pre', 'save', newData, this).then(function () {\n      _this3.collection.schema.validate(newData);\n\n      startTime = now();\n      return _this3.collection._pouchPut(newData);\n    }).then(function (ret) {\n      var endTime = now();\n\n      if (!ret.ok) {\n        throw newRxError('DOC12', {\n          data: ret\n        });\n      }\n\n      newData._rev = ret.rev; // emit event\n\n      var changeEvent = createUpdateEvent(_this3.collection, newData, oldData, startTime, endTime, _this3);\n\n      _this3.$emit(changeEvent);\n\n      return _this3.collection._runHooks('post', 'save', newData, _this3);\n    });\n  },\n\n  /**\n   * saves the temporary document and makes a non-temporary out of it\n   * Saving a temporary doc is basically the same as RxCollection.insert()\n   * @return false if nothing to save\n   */\n  save: function save() {\n    var _this4 = this;\n\n    // .save() cannot be called on non-temporary-documents\n    if (!this._isTemporary) {\n      throw newRxError('DOC17', {\n        id: this.primary,\n        document: this\n      });\n    }\n\n    return this.collection.insert(this).then(function () {\n      _this4._isTemporary = false;\n\n      _this4.collection._docCache.set(_this4.primary, _this4); // internal events\n\n\n      _this4._dataSync$.next(_this4._data);\n\n      return true;\n    });\n  },\n\n  /**\n   * remove the document,\n   * this not not equal to a pouchdb.remove(),\n   * instead we keep the values and only set _deleted: true\n   */\n  remove: function remove() {\n    var _this5 = this;\n\n    if (this.deleted) {\n      return Promise.reject(newRxError('DOC13', {\n        document: this,\n        id: this.primary\n      }));\n    }\n\n    var deletedData = clone(this._data);\n    var startTime;\n    return this.collection._runHooks('pre', 'remove', deletedData, this).then(function () {\n      deletedData._deleted = true;\n      startTime = now();\n      /**\n       * because pouch.remove will also empty the object,\n       * we set _deleted: true and use pouch.put\n       */\n\n      return _this5.collection._pouchPut(deletedData);\n    }).then(function () {\n      var endTime = now();\n\n      _this5.$emit(createDeleteEvent(_this5.collection, deletedData, _this5._data, startTime, endTime, _this5));\n\n      return _this5.collection._runHooks('post', 'remove', deletedData, _this5);\n    }).then(function () {\n      return _this5;\n    });\n  },\n  destroy: function destroy() {\n    throw newRxError('DOC14');\n  }\n};\nexport function createRxDocumentConstructor() {\n  var proto = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : basePrototype;\n\n  var constructor = function RxDocumentConstructor(collection, jsonData) {\n    this.collection = collection; // if true, this is a temporary document\n\n    this._isTemporary = false; // assume that this is always equal to the doc-data in the database\n\n    this._dataSync$ = new BehaviorSubject(jsonData);\n    this._deleted$ = new BehaviorSubject(false);\n    this._atomicQueue = Promise.resolve();\n    /**\n     * because of the prototype-merge,\n     * we can not use the native instanceof operator\n     */\n\n    this.isInstanceOfRxDocument = true;\n  };\n\n  constructor.prototype = proto;\n  return constructor;\n}\nexport function defineGetterSetter(schema, valueObj) {\n  var objPath = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : '';\n  var thisObj = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : false;\n  if (valueObj === null) return;\n  var pathProperties = schema.getSchemaByObjectPath(objPath);\n  if (typeof pathProperties === 'undefined') return;\n  if (pathProperties.properties) pathProperties = pathProperties.properties;\n  Object.keys(pathProperties).forEach(function (key) {\n    var fullPath = trimDots(objPath + '.' + key); // getter - value\n\n    valueObj.__defineGetter__(key, function () {\n      var _this = thisObj ? thisObj : this;\n\n      if (!_this.get || typeof _this.get !== 'function') {\n        /**\n         * When an object gets added to the state of a vuejs-component,\n         * it happens that this getter is called with another scope.\n         * To prevent errors, we have to return undefined in this case\n         */\n        return undefined;\n      }\n\n      var ret = _this.get(fullPath);\n\n      return ret;\n    }); // getter - observable$\n\n\n    Object.defineProperty(valueObj, key + '$', {\n      get: function get() {\n        var _this = thisObj ? thisObj : this;\n\n        return _this.get$(fullPath);\n      },\n      enumerable: false,\n      configurable: false\n    }); // getter - populate_\n\n    Object.defineProperty(valueObj, key + '_', {\n      get: function get() {\n        var _this = thisObj ? thisObj : this;\n\n        return _this.populate(fullPath);\n      },\n      enumerable: false,\n      configurable: false\n    }); // setter - value\n\n    valueObj.__defineSetter__(key, function (val) {\n      var _this = thisObj ? thisObj : this;\n\n      return _this.set(fullPath, val);\n    });\n  });\n}\nexport function createWithConstructor(constructor, collection, jsonData) {\n  if (jsonData[collection.schema.primaryPath] && jsonData[collection.schema.primaryPath].startsWith('_design')) return null;\n  var doc = new constructor(collection, jsonData);\n  runPluginHooks('createRxDocument', doc);\n  return doc;\n}\nexport function isInstanceOf(obj) {\n  if (typeof obj === 'undefined') return false;\n  return !!obj.isInstanceOfRxDocument;\n}\n//# sourceMappingURL=rx-document.js.map"]},"metadata":{},"sourceType":"module"}