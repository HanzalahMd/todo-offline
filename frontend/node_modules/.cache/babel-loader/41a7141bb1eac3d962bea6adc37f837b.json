{"ast":null,"code":"import { sleep, randomToken } from './util.js';\nimport unload from 'unload';\n\nvar LeaderElection = function LeaderElection(channel, options) {\n  this._channel = channel;\n  this._options = options;\n  this.isLeader = false;\n  this.isDead = false;\n  this.token = randomToken();\n  this._isApl = false; // _isApplying\n\n  this._reApply = false; // things to clean up\n\n  this._unl = []; // _unloads\n\n  this._lstns = []; // _listeners\n\n  this._invs = []; // _intervals\n};\n\nLeaderElection.prototype = {\n  applyOnce: function applyOnce() {\n    var _this = this;\n\n    if (this.isLeader) return Promise.resolve(false);\n    if (this.isDead) return Promise.resolve(false); // do nothing if already running\n\n    if (this._isApl) {\n      this._reApply = true;\n      return Promise.resolve(false);\n    }\n\n    this._isApl = true;\n    var stopCriteria = false;\n    var recieved = [];\n\n    var handleMessage = function handleMessage(msg) {\n      if (msg.context === 'leader' && msg.token != _this.token) {\n        recieved.push(msg);\n\n        if (msg.action === 'apply') {\n          // other is applying\n          if (msg.token > _this.token) {\n            // other has higher token, stop applying\n            stopCriteria = true;\n          }\n        }\n\n        if (msg.action === 'tell') {\n          // other is already leader\n          stopCriteria = true;\n        }\n      }\n    };\n\n    this._channel.addEventListener('internal', handleMessage);\n\n    var ret = _sendMessage(this, 'apply') // send out that this one is applying\n    .then(function () {\n      return sleep(_this._options.responseTime);\n    }) // let others time to respond\n    .then(function () {\n      if (stopCriteria) return Promise.reject(new Error());else return _sendMessage(_this, 'apply');\n    }).then(function () {\n      return sleep(_this._options.responseTime);\n    }) // let others time to respond\n    .then(function () {\n      if (stopCriteria) return Promise.reject(new Error());else return _sendMessage(_this);\n    }).then(function () {\n      return _beLeader(_this);\n    }) // no one disagreed -> this one is now leader\n    .then(function () {\n      return true;\n    })[\"catch\"](function () {\n      return false;\n    }) // apply not successfull\n    .then(function (success) {\n      _this._channel.removeEventListener('internal', handleMessage);\n\n      _this._isApl = false;\n\n      if (!success && _this._reApply) {\n        _this._reApply = false;\n        return _this.applyOnce();\n      } else return success;\n    });\n\n    return ret;\n  },\n  awaitLeadership: function awaitLeadership() {\n    if (\n    /* _awaitLeadershipPromise */\n    !this._aLP) {\n      this._aLP = _awaitLeadershipOnce(this);\n    }\n\n    return this._aLP;\n  },\n  die: function die() {\n    var _this2 = this;\n\n    if (this.isDead) return;\n    this.isDead = true;\n\n    this._lstns.forEach(function (listener) {\n      return _this2._channel.removeEventListener('internal', listener);\n    });\n\n    this._invs.forEach(function (interval) {\n      return clearInterval(interval);\n    });\n\n    this._unl.forEach(function (uFn) {\n      uFn.remove();\n    });\n\n    return _sendMessage(this, 'death');\n  }\n};\n\nfunction _awaitLeadershipOnce(leaderElector) {\n  if (leaderElector.isLeader) return Promise.resolve();\n  return new Promise(function (res) {\n    var resolved = false;\n\n    var finish = function finish() {\n      if (resolved) return;\n      resolved = true;\n      clearInterval(interval);\n\n      leaderElector._channel.removeEventListener('internal', whenDeathListener);\n\n      res(true);\n    }; // try once now\n\n\n    leaderElector.applyOnce().then(function () {\n      if (leaderElector.isLeader) finish();\n    }); // try on fallbackInterval\n\n    var interval = setInterval(function () {\n      leaderElector.applyOnce().then(function () {\n        if (leaderElector.isLeader) finish();\n      });\n    }, leaderElector._options.fallbackInterval);\n\n    leaderElector._invs.push(interval); // try when other leader dies\n\n\n    var whenDeathListener = function whenDeathListener(msg) {\n      if (msg.context === 'leader' && msg.action === 'death') {\n        leaderElector.applyOnce().then(function () {\n          if (leaderElector.isLeader) finish();\n        });\n      }\n    };\n\n    leaderElector._channel.addEventListener('internal', whenDeathListener);\n\n    leaderElector._lstns.push(whenDeathListener);\n  });\n}\n/**\n * sends and internal message over the broadcast-channel\n */\n\n\nfunction _sendMessage(leaderElector, action) {\n  var msgJson = {\n    context: 'leader',\n    action: action,\n    token: leaderElector.token\n  };\n  return leaderElector._channel.postInternal(msgJson);\n}\n\nfunction _beLeader(leaderElector) {\n  leaderElector.isLeader = true;\n  var unloadFn = unload.add(function () {\n    return leaderElector.die();\n  });\n\n  leaderElector._unl.push(unloadFn);\n\n  var isLeaderListener = function isLeaderListener(msg) {\n    if (msg.context === 'leader' && msg.action === 'apply') {\n      _sendMessage(leaderElector, 'tell');\n    }\n  };\n\n  leaderElector._channel.addEventListener('internal', isLeaderListener);\n\n  leaderElector._lstns.push(isLeaderListener);\n\n  return _sendMessage(leaderElector, 'tell');\n}\n\nfunction fillOptionsWithDefaults(options, channel) {\n  if (!options) options = {};\n  options = JSON.parse(JSON.stringify(options));\n\n  if (!options.fallbackInterval) {\n    options.fallbackInterval = 3000;\n  }\n\n  if (!options.responseTime) {\n    options.responseTime = channel.method.averageResponseTime(channel.options);\n  }\n\n  return options;\n}\n\nexport function createLeaderElection(channel, options) {\n  if (channel._leaderElector) {\n    throw new Error('BroadcastChannel already has a leader-elector');\n  }\n\n  options = fillOptionsWithDefaults(options, channel);\n  var elector = new LeaderElection(channel, options);\n\n  channel._befC.push(function () {\n    return elector.die();\n  });\n\n  channel._leaderElector = elector;\n  return elector;\n}","map":{"version":3,"sources":["/Users/Hanzalah/Desktop/github/todo-offline/rxdb-hasura-demo/node_modules/broadcast-channel/dist/es/leader-election.js"],"names":["sleep","randomToken","unload","LeaderElection","channel","options","_channel","_options","isLeader","isDead","token","_isApl","_reApply","_unl","_lstns","_invs","prototype","applyOnce","_this","Promise","resolve","stopCriteria","recieved","handleMessage","msg","context","push","action","addEventListener","ret","_sendMessage","then","responseTime","reject","Error","_beLeader","success","removeEventListener","awaitLeadership","_aLP","_awaitLeadershipOnce","die","_this2","forEach","listener","interval","clearInterval","uFn","remove","leaderElector","res","resolved","finish","whenDeathListener","setInterval","fallbackInterval","msgJson","postInternal","unloadFn","add","isLeaderListener","fillOptionsWithDefaults","JSON","parse","stringify","method","averageResponseTime","createLeaderElection","_leaderElector","elector","_befC"],"mappings":"AAAA,SAASA,KAAT,EAAgBC,WAAhB,QAAmC,WAAnC;AACA,OAAOC,MAAP,MAAmB,QAAnB;;AAEA,IAAIC,cAAc,GAAG,SAASA,cAAT,CAAwBC,OAAxB,EAAiCC,OAAjC,EAA0C;AAC7D,OAAKC,QAAL,GAAgBF,OAAhB;AACA,OAAKG,QAAL,GAAgBF,OAAhB;AACA,OAAKG,QAAL,GAAgB,KAAhB;AACA,OAAKC,MAAL,GAAc,KAAd;AACA,OAAKC,KAAL,GAAaT,WAAW,EAAxB;AACA,OAAKU,MAAL,GAAc,KAAd,CAN6D,CAMxC;;AAErB,OAAKC,QAAL,GAAgB,KAAhB,CAR6D,CAQtC;;AAEvB,OAAKC,IAAL,GAAY,EAAZ,CAV6D,CAU7C;;AAEhB,OAAKC,MAAL,GAAc,EAAd,CAZ6D,CAY3C;;AAElB,OAAKC,KAAL,GAAa,EAAb,CAd6D,CAc5C;AAClB,CAfD;;AAiBAZ,cAAc,CAACa,SAAf,GAA2B;AACzBC,EAAAA,SAAS,EAAE,SAASA,SAAT,GAAqB;AAC9B,QAAIC,KAAK,GAAG,IAAZ;;AAEA,QAAI,KAAKV,QAAT,EAAmB,OAAOW,OAAO,CAACC,OAAR,CAAgB,KAAhB,CAAP;AACnB,QAAI,KAAKX,MAAT,EAAiB,OAAOU,OAAO,CAACC,OAAR,CAAgB,KAAhB,CAAP,CAJa,CAIkB;;AAEhD,QAAI,KAAKT,MAAT,EAAiB;AACf,WAAKC,QAAL,GAAgB,IAAhB;AACA,aAAOO,OAAO,CAACC,OAAR,CAAgB,KAAhB,CAAP;AACD;;AAED,SAAKT,MAAL,GAAc,IAAd;AACA,QAAIU,YAAY,GAAG,KAAnB;AACA,QAAIC,QAAQ,GAAG,EAAf;;AAEA,QAAIC,aAAa,GAAG,SAASA,aAAT,CAAuBC,GAAvB,EAA4B;AAC9C,UAAIA,GAAG,CAACC,OAAJ,KAAgB,QAAhB,IAA4BD,GAAG,CAACd,KAAJ,IAAaQ,KAAK,CAACR,KAAnD,EAA0D;AACxDY,QAAAA,QAAQ,CAACI,IAAT,CAAcF,GAAd;;AAEA,YAAIA,GAAG,CAACG,MAAJ,KAAe,OAAnB,EAA4B;AAC1B;AACA,cAAIH,GAAG,CAACd,KAAJ,GAAYQ,KAAK,CAACR,KAAtB,EAA6B;AAC3B;AACAW,YAAAA,YAAY,GAAG,IAAf;AACD;AACF;;AAED,YAAIG,GAAG,CAACG,MAAJ,KAAe,MAAnB,EAA2B;AACzB;AACAN,UAAAA,YAAY,GAAG,IAAf;AACD;AACF;AACF,KAjBD;;AAmBA,SAAKf,QAAL,CAAcsB,gBAAd,CAA+B,UAA/B,EAA2CL,aAA3C;;AAEA,QAAIM,GAAG,GAAGC,YAAY,CAAC,IAAD,EAAO,OAAP,CAAZ,CAA4B;AAA5B,KACTC,IADS,CACJ,YAAY;AAChB,aAAO/B,KAAK,CAACkB,KAAK,CAACX,QAAN,CAAeyB,YAAhB,CAAZ;AACD,KAHS,EAGP;AAHO,KAITD,IAJS,CAIJ,YAAY;AAChB,UAAIV,YAAJ,EAAkB,OAAOF,OAAO,CAACc,MAAR,CAAe,IAAIC,KAAJ,EAAf,CAAP,CAAlB,KAA0D,OAAOJ,YAAY,CAACZ,KAAD,EAAQ,OAAR,CAAnB;AAC3D,KANS,EAMPa,IANO,CAMF,YAAY;AAClB,aAAO/B,KAAK,CAACkB,KAAK,CAACX,QAAN,CAAeyB,YAAhB,CAAZ;AACD,KARS,EAQP;AARO,KASTD,IATS,CASJ,YAAY;AAChB,UAAIV,YAAJ,EAAkB,OAAOF,OAAO,CAACc,MAAR,CAAe,IAAIC,KAAJ,EAAf,CAAP,CAAlB,KAA0D,OAAOJ,YAAY,CAACZ,KAAD,CAAnB;AAC3D,KAXS,EAWPa,IAXO,CAWF,YAAY;AAClB,aAAOI,SAAS,CAACjB,KAAD,CAAhB;AACD,KAbS,EAaP;AAbO,KAcTa,IAdS,CAcJ,YAAY;AAChB,aAAO,IAAP;AACD,KAhBS,EAgBP,OAhBO,EAgBE,YAAY;AACtB,aAAO,KAAP;AACD,KAlBS,EAkBP;AAlBO,KAmBTA,IAnBS,CAmBJ,UAAUK,OAAV,EAAmB;AACvBlB,MAAAA,KAAK,CAACZ,QAAN,CAAe+B,mBAAf,CAAmC,UAAnC,EAA+Cd,aAA/C;;AAEAL,MAAAA,KAAK,CAACP,MAAN,GAAe,KAAf;;AAEA,UAAI,CAACyB,OAAD,IAAYlB,KAAK,CAACN,QAAtB,EAAgC;AAC9BM,QAAAA,KAAK,CAACN,QAAN,GAAiB,KAAjB;AACA,eAAOM,KAAK,CAACD,SAAN,EAAP;AACD,OAHD,MAGO,OAAOmB,OAAP;AACR,KA5BS,CAAV;;AA8BA,WAAOP,GAAP;AACD,GApEwB;AAqEzBS,EAAAA,eAAe,EAAE,SAASA,eAAT,GAA2B;AAC1C;AACA;AACA,KAAC,KAAKC,IAFN,EAEY;AACV,WAAKA,IAAL,GAAYC,oBAAoB,CAAC,IAAD,CAAhC;AACD;;AAED,WAAO,KAAKD,IAAZ;AACD,GA7EwB;AA8EzBE,EAAAA,GAAG,EAAE,SAASA,GAAT,GAAe;AAClB,QAAIC,MAAM,GAAG,IAAb;;AAEA,QAAI,KAAKjC,MAAT,EAAiB;AACjB,SAAKA,MAAL,GAAc,IAAd;;AAEA,SAAKK,MAAL,CAAY6B,OAAZ,CAAoB,UAAUC,QAAV,EAAoB;AACtC,aAAOF,MAAM,CAACpC,QAAP,CAAgB+B,mBAAhB,CAAoC,UAApC,EAAgDO,QAAhD,CAAP;AACD,KAFD;;AAIA,SAAK7B,KAAL,CAAW4B,OAAX,CAAmB,UAAUE,QAAV,EAAoB;AACrC,aAAOC,aAAa,CAACD,QAAD,CAApB;AACD,KAFD;;AAIA,SAAKhC,IAAL,CAAU8B,OAAV,CAAkB,UAAUI,GAAV,EAAe;AAC/BA,MAAAA,GAAG,CAACC,MAAJ;AACD,KAFD;;AAIA,WAAOlB,YAAY,CAAC,IAAD,EAAO,OAAP,CAAnB;AACD;AAjGwB,CAA3B;;AAoGA,SAASU,oBAAT,CAA8BS,aAA9B,EAA6C;AAC3C,MAAIA,aAAa,CAACzC,QAAlB,EAA4B,OAAOW,OAAO,CAACC,OAAR,EAAP;AAC5B,SAAO,IAAID,OAAJ,CAAY,UAAU+B,GAAV,EAAe;AAChC,QAAIC,QAAQ,GAAG,KAAf;;AAEA,QAAIC,MAAM,GAAG,SAASA,MAAT,GAAkB;AAC7B,UAAID,QAAJ,EAAc;AACdA,MAAAA,QAAQ,GAAG,IAAX;AACAL,MAAAA,aAAa,CAACD,QAAD,CAAb;;AAEAI,MAAAA,aAAa,CAAC3C,QAAd,CAAuB+B,mBAAvB,CAA2C,UAA3C,EAAuDgB,iBAAvD;;AAEAH,MAAAA,GAAG,CAAC,IAAD,CAAH;AACD,KARD,CAHgC,CAW7B;;;AAGHD,IAAAA,aAAa,CAAChC,SAAd,GAA0Bc,IAA1B,CAA+B,YAAY;AACzC,UAAIkB,aAAa,CAACzC,QAAlB,EAA4B4C,MAAM;AACnC,KAFD,EAdgC,CAgB5B;;AAEJ,QAAIP,QAAQ,GAAGS,WAAW,CAAC,YAAY;AACrCL,MAAAA,aAAa,CAAChC,SAAd,GAA0Bc,IAA1B,CAA+B,YAAY;AACzC,YAAIkB,aAAa,CAACzC,QAAlB,EAA4B4C,MAAM;AACnC,OAFD;AAGD,KAJyB,EAIvBH,aAAa,CAAC1C,QAAd,CAAuBgD,gBAJA,CAA1B;;AAMAN,IAAAA,aAAa,CAAClC,KAAd,CAAoBW,IAApB,CAAyBmB,QAAzB,EAxBgC,CAwBI;;;AAGpC,QAAIQ,iBAAiB,GAAG,SAASA,iBAAT,CAA2B7B,GAA3B,EAAgC;AACtD,UAAIA,GAAG,CAACC,OAAJ,KAAgB,QAAhB,IAA4BD,GAAG,CAACG,MAAJ,KAAe,OAA/C,EAAwD;AACtDsB,QAAAA,aAAa,CAAChC,SAAd,GAA0Bc,IAA1B,CAA+B,YAAY;AACzC,cAAIkB,aAAa,CAACzC,QAAlB,EAA4B4C,MAAM;AACnC,SAFD;AAGD;AACF,KAND;;AAQAH,IAAAA,aAAa,CAAC3C,QAAd,CAAuBsB,gBAAvB,CAAwC,UAAxC,EAAoDyB,iBAApD;;AAEAJ,IAAAA,aAAa,CAACnC,MAAd,CAAqBY,IAArB,CAA0B2B,iBAA1B;AACD,GAtCM,CAAP;AAuCD;AACD;;;;;AAKA,SAASvB,YAAT,CAAsBmB,aAAtB,EAAqCtB,MAArC,EAA6C;AAC3C,MAAI6B,OAAO,GAAG;AACZ/B,IAAAA,OAAO,EAAE,QADG;AAEZE,IAAAA,MAAM,EAAEA,MAFI;AAGZjB,IAAAA,KAAK,EAAEuC,aAAa,CAACvC;AAHT,GAAd;AAKA,SAAOuC,aAAa,CAAC3C,QAAd,CAAuBmD,YAAvB,CAAoCD,OAApC,CAAP;AACD;;AAED,SAASrB,SAAT,CAAmBc,aAAnB,EAAkC;AAChCA,EAAAA,aAAa,CAACzC,QAAd,GAAyB,IAAzB;AACA,MAAIkD,QAAQ,GAAGxD,MAAM,CAACyD,GAAP,CAAW,YAAY;AACpC,WAAOV,aAAa,CAACR,GAAd,EAAP;AACD,GAFc,CAAf;;AAIAQ,EAAAA,aAAa,CAACpC,IAAd,CAAmBa,IAAnB,CAAwBgC,QAAxB;;AAEA,MAAIE,gBAAgB,GAAG,SAASA,gBAAT,CAA0BpC,GAA1B,EAA+B;AACpD,QAAIA,GAAG,CAACC,OAAJ,KAAgB,QAAhB,IAA4BD,GAAG,CAACG,MAAJ,KAAe,OAA/C,EAAwD;AACtDG,MAAAA,YAAY,CAACmB,aAAD,EAAgB,MAAhB,CAAZ;AACD;AACF,GAJD;;AAMAA,EAAAA,aAAa,CAAC3C,QAAd,CAAuBsB,gBAAvB,CAAwC,UAAxC,EAAoDgC,gBAApD;;AAEAX,EAAAA,aAAa,CAACnC,MAAd,CAAqBY,IAArB,CAA0BkC,gBAA1B;;AAEA,SAAO9B,YAAY,CAACmB,aAAD,EAAgB,MAAhB,CAAnB;AACD;;AAED,SAASY,uBAAT,CAAiCxD,OAAjC,EAA0CD,OAA1C,EAAmD;AACjD,MAAI,CAACC,OAAL,EAAcA,OAAO,GAAG,EAAV;AACdA,EAAAA,OAAO,GAAGyD,IAAI,CAACC,KAAL,CAAWD,IAAI,CAACE,SAAL,CAAe3D,OAAf,CAAX,CAAV;;AAEA,MAAI,CAACA,OAAO,CAACkD,gBAAb,EAA+B;AAC7BlD,IAAAA,OAAO,CAACkD,gBAAR,GAA2B,IAA3B;AACD;;AAED,MAAI,CAAClD,OAAO,CAAC2B,YAAb,EAA2B;AACzB3B,IAAAA,OAAO,CAAC2B,YAAR,GAAuB5B,OAAO,CAAC6D,MAAR,CAAeC,mBAAf,CAAmC9D,OAAO,CAACC,OAA3C,CAAvB;AACD;;AAED,SAAOA,OAAP;AACD;;AAED,OAAO,SAAS8D,oBAAT,CAA8B/D,OAA9B,EAAuCC,OAAvC,EAAgD;AACrD,MAAID,OAAO,CAACgE,cAAZ,EAA4B;AAC1B,UAAM,IAAIlC,KAAJ,CAAU,+CAAV,CAAN;AACD;;AAED7B,EAAAA,OAAO,GAAGwD,uBAAuB,CAACxD,OAAD,EAAUD,OAAV,CAAjC;AACA,MAAIiE,OAAO,GAAG,IAAIlE,cAAJ,CAAmBC,OAAnB,EAA4BC,OAA5B,CAAd;;AAEAD,EAAAA,OAAO,CAACkE,KAAR,CAAc5C,IAAd,CAAmB,YAAY;AAC7B,WAAO2C,OAAO,CAAC5B,GAAR,EAAP;AACD,GAFD;;AAIArC,EAAAA,OAAO,CAACgE,cAAR,GAAyBC,OAAzB;AACA,SAAOA,OAAP;AACD","sourcesContent":["import { sleep, randomToken } from './util.js';\nimport unload from 'unload';\n\nvar LeaderElection = function LeaderElection(channel, options) {\n  this._channel = channel;\n  this._options = options;\n  this.isLeader = false;\n  this.isDead = false;\n  this.token = randomToken();\n  this._isApl = false; // _isApplying\n\n  this._reApply = false; // things to clean up\n\n  this._unl = []; // _unloads\n\n  this._lstns = []; // _listeners\n\n  this._invs = []; // _intervals\n};\n\nLeaderElection.prototype = {\n  applyOnce: function applyOnce() {\n    var _this = this;\n\n    if (this.isLeader) return Promise.resolve(false);\n    if (this.isDead) return Promise.resolve(false); // do nothing if already running\n\n    if (this._isApl) {\n      this._reApply = true;\n      return Promise.resolve(false);\n    }\n\n    this._isApl = true;\n    var stopCriteria = false;\n    var recieved = [];\n\n    var handleMessage = function handleMessage(msg) {\n      if (msg.context === 'leader' && msg.token != _this.token) {\n        recieved.push(msg);\n\n        if (msg.action === 'apply') {\n          // other is applying\n          if (msg.token > _this.token) {\n            // other has higher token, stop applying\n            stopCriteria = true;\n          }\n        }\n\n        if (msg.action === 'tell') {\n          // other is already leader\n          stopCriteria = true;\n        }\n      }\n    };\n\n    this._channel.addEventListener('internal', handleMessage);\n\n    var ret = _sendMessage(this, 'apply') // send out that this one is applying\n    .then(function () {\n      return sleep(_this._options.responseTime);\n    }) // let others time to respond\n    .then(function () {\n      if (stopCriteria) return Promise.reject(new Error());else return _sendMessage(_this, 'apply');\n    }).then(function () {\n      return sleep(_this._options.responseTime);\n    }) // let others time to respond\n    .then(function () {\n      if (stopCriteria) return Promise.reject(new Error());else return _sendMessage(_this);\n    }).then(function () {\n      return _beLeader(_this);\n    }) // no one disagreed -> this one is now leader\n    .then(function () {\n      return true;\n    })[\"catch\"](function () {\n      return false;\n    }) // apply not successfull\n    .then(function (success) {\n      _this._channel.removeEventListener('internal', handleMessage);\n\n      _this._isApl = false;\n\n      if (!success && _this._reApply) {\n        _this._reApply = false;\n        return _this.applyOnce();\n      } else return success;\n    });\n\n    return ret;\n  },\n  awaitLeadership: function awaitLeadership() {\n    if (\n    /* _awaitLeadershipPromise */\n    !this._aLP) {\n      this._aLP = _awaitLeadershipOnce(this);\n    }\n\n    return this._aLP;\n  },\n  die: function die() {\n    var _this2 = this;\n\n    if (this.isDead) return;\n    this.isDead = true;\n\n    this._lstns.forEach(function (listener) {\n      return _this2._channel.removeEventListener('internal', listener);\n    });\n\n    this._invs.forEach(function (interval) {\n      return clearInterval(interval);\n    });\n\n    this._unl.forEach(function (uFn) {\n      uFn.remove();\n    });\n\n    return _sendMessage(this, 'death');\n  }\n};\n\nfunction _awaitLeadershipOnce(leaderElector) {\n  if (leaderElector.isLeader) return Promise.resolve();\n  return new Promise(function (res) {\n    var resolved = false;\n\n    var finish = function finish() {\n      if (resolved) return;\n      resolved = true;\n      clearInterval(interval);\n\n      leaderElector._channel.removeEventListener('internal', whenDeathListener);\n\n      res(true);\n    }; // try once now\n\n\n    leaderElector.applyOnce().then(function () {\n      if (leaderElector.isLeader) finish();\n    }); // try on fallbackInterval\n\n    var interval = setInterval(function () {\n      leaderElector.applyOnce().then(function () {\n        if (leaderElector.isLeader) finish();\n      });\n    }, leaderElector._options.fallbackInterval);\n\n    leaderElector._invs.push(interval); // try when other leader dies\n\n\n    var whenDeathListener = function whenDeathListener(msg) {\n      if (msg.context === 'leader' && msg.action === 'death') {\n        leaderElector.applyOnce().then(function () {\n          if (leaderElector.isLeader) finish();\n        });\n      }\n    };\n\n    leaderElector._channel.addEventListener('internal', whenDeathListener);\n\n    leaderElector._lstns.push(whenDeathListener);\n  });\n}\n/**\n * sends and internal message over the broadcast-channel\n */\n\n\nfunction _sendMessage(leaderElector, action) {\n  var msgJson = {\n    context: 'leader',\n    action: action,\n    token: leaderElector.token\n  };\n  return leaderElector._channel.postInternal(msgJson);\n}\n\nfunction _beLeader(leaderElector) {\n  leaderElector.isLeader = true;\n  var unloadFn = unload.add(function () {\n    return leaderElector.die();\n  });\n\n  leaderElector._unl.push(unloadFn);\n\n  var isLeaderListener = function isLeaderListener(msg) {\n    if (msg.context === 'leader' && msg.action === 'apply') {\n      _sendMessage(leaderElector, 'tell');\n    }\n  };\n\n  leaderElector._channel.addEventListener('internal', isLeaderListener);\n\n  leaderElector._lstns.push(isLeaderListener);\n\n  return _sendMessage(leaderElector, 'tell');\n}\n\nfunction fillOptionsWithDefaults(options, channel) {\n  if (!options) options = {};\n  options = JSON.parse(JSON.stringify(options));\n\n  if (!options.fallbackInterval) {\n    options.fallbackInterval = 3000;\n  }\n\n  if (!options.responseTime) {\n    options.responseTime = channel.method.averageResponseTime(channel.options);\n  }\n\n  return options;\n}\n\nexport function createLeaderElection(channel, options) {\n  if (channel._leaderElector) {\n    throw new Error('BroadcastChannel already has a leader-elector');\n  }\n\n  options = fillOptionsWithDefaults(options, channel);\n  var elector = new LeaderElection(channel, options);\n\n  channel._befC.push(function () {\n    return elector.die();\n  });\n\n  channel._leaderElector = elector;\n  return elector;\n}"]},"metadata":{},"sourceType":"module"}