{"ast":null,"code":"import _inheritsLoose from \"@babel/runtime/helpers/inheritsLoose\";\n/**\n * This plugin adds the local-documents-support\n * Local documents behave equal then with pouchdb\n * @link https://pouchdb.com/guides/local-documents.html\n */\n\nimport objectPath from 'object-path';\nimport { createRxDocumentConstructor, basePrototype } from '../rx-document';\nimport { createChangeEvent } from '../rx-change-event';\nimport { createDocCache } from '../doc-cache';\nimport { newRxError, newRxTypeError } from '../rx-error';\nimport { clone } from '../util';\nimport { isInstanceOf as isRxDatabase } from '../rx-database';\nimport { isInstanceOf as isRxCollection } from '../rx-collection';\nimport { filter, map, distinctUntilChanged } from 'rxjs/operators';\nvar DOC_CACHE_BY_PARENT = new WeakMap();\n\nvar _getDocCache = function _getDocCache(parent) {\n  if (!DOC_CACHE_BY_PARENT.has(parent)) {\n    DOC_CACHE_BY_PARENT.set(parent, createDocCache());\n  }\n\n  return DOC_CACHE_BY_PARENT.get(parent);\n};\n\nvar CHANGE_SUB_BY_PARENT = new WeakMap();\n\nvar _getChangeSub = function _getChangeSub(parent) {\n  if (!CHANGE_SUB_BY_PARENT.has(parent)) {\n    var sub = parent.$.pipe(filter(function (cE) {\n      return cE.data.isLocal;\n    })).subscribe(function (cE) {\n      var docCache = _getDocCache(parent);\n\n      var doc = docCache.get(cE.data.doc);\n      if (doc) doc._handleChangeEvent(cE);\n    });\n\n    parent._subs.push(sub);\n\n    CHANGE_SUB_BY_PARENT.set(parent, sub);\n  }\n\n  return CHANGE_SUB_BY_PARENT.get(parent);\n};\n\nvar LOCAL_PREFIX = '_local/';\nvar RxDocumentParent = createRxDocumentConstructor();\nexport var RxLocalDocument =\n/*#__PURE__*/\nfunction (_RxDocumentParent) {\n  _inheritsLoose(RxLocalDocument, _RxDocumentParent);\n\n  function RxLocalDocument(id, jsonData, parent) {\n    var _this;\n\n    _this = _RxDocumentParent.call(this, null, jsonData) || this;\n    _this.id = id;\n    _this.parent = parent;\n    return _this;\n  }\n\n  return RxLocalDocument;\n}(RxDocumentParent);\n\nvar _getPouchByParent = function _getPouchByParent(parent) {\n  if (isRxDatabase(parent)) return parent._adminPouch; // database\n  else return parent.pouch; // collection\n};\n\nvar RxLocalDocumentPrototype = {\n  toPouchJson: function toPouchJson() {\n    var data = clone(this._data);\n    data._id = LOCAL_PREFIX + this.id;\n  },\n\n  get isLocal() {\n    return true;\n  },\n\n  get parentPouch() {\n    return _getPouchByParent(this.parent);\n  },\n\n  //\n  // overwrites\n  //\n  _handleChangeEvent: function _handleChangeEvent(changeEvent) {\n    if (changeEvent.data.doc !== this.primary) return;\n\n    switch (changeEvent.data.op) {\n      case 'UPDATE':\n        var newData = clone(changeEvent.data.v);\n\n        this._dataSync$.next(clone(newData));\n\n        break;\n\n      case 'REMOVE':\n        // remove from docCache to assure new upserted RxDocuments will be a new instance\n        var docCache = _getDocCache(this.parent);\n\n        docCache[\"delete\"](this.primary);\n\n        this._deleted$.next(true);\n\n        break;\n    }\n  },\n\n  get allAttachments$() {\n    // this is overwritten here because we cannot re-set getters on the prototype\n    throw newRxError('LD1', {\n      document: this\n    });\n  },\n\n  get primaryPath() {\n    return 'id';\n  },\n\n  get primary() {\n    return this.id;\n  },\n\n  get $() {\n    return this._dataSync$.asObservable();\n  },\n\n  $emit: function $emit(changeEvent) {\n    return this.parent.$emit(changeEvent);\n  },\n  get: function get(objPath) {\n    if (!this._data) return undefined;\n\n    if (typeof objPath !== 'string') {\n      throw newRxTypeError('LD2', {\n        objPath: objPath\n      });\n    }\n\n    var valueObj = objectPath.get(this._data, objPath);\n    valueObj = clone(valueObj);\n    return valueObj;\n  },\n  get$: function get$(path) {\n    if (path.includes('.item.')) {\n      throw newRxError('LD3', {\n        path: path\n      });\n    }\n\n    if (path === this.primaryPath) throw newRxError('LD4');\n    return this._dataSync$.pipe(map(function (data) {\n      return objectPath.get(data, path);\n    }), distinctUntilChanged());\n  },\n  set: function set(objPath, value) {\n    if (!value) {\n      // object path not set, overwrite whole data\n      var data = clone(objPath);\n      data._rev = this._data._rev;\n      this._data = data;\n      return this;\n    }\n\n    if (objPath === '_id') {\n      throw newRxError('LD5', {\n        objPath: objPath,\n        value: value\n      });\n    }\n\n    if (Object.is(this.get(objPath), value)) return;\n    objectPath.set(this._data, objPath, value);\n    return this;\n  },\n  _saveData: function _saveData(newData) {\n    var _this2 = this;\n\n    newData = clone(newData);\n    newData._id = LOCAL_PREFIX + this.id;\n    return this.parentPouch.put(newData).then(function (res) {\n      newData._rev = res.rev;\n\n      _this2._dataSync$.next(newData);\n\n      var changeEvent = createChangeEvent('UPDATE', isRxDatabase(_this2.parent) ? _this2.parent : _this2.parent.database, isRxCollection(_this2.parent) ? _this2.parent : null, _this2, clone(_this2._data), true);\n\n      _this2.$emit(changeEvent);\n    });\n  },\n  remove: function remove() {\n    var _this3 = this;\n\n    var removeId = LOCAL_PREFIX + this.id;\n    return this.parentPouch.remove(removeId, this._data._rev).then(function () {\n      _getDocCache(_this3.parent)[\"delete\"](_this3.id);\n\n      var changeEvent = createChangeEvent('REMOVE', isRxDatabase(_this3.parent) ? _this3.parent : _this3.parent.database, isRxCollection(_this3.parent) ? _this3.parent : null, _this3, clone(_this3._data), true);\n\n      _this3.$emit(changeEvent);\n    });\n  }\n};\nvar INIT_DONE = false;\n\nvar _init = function _init() {\n  if (INIT_DONE) return;else INIT_DONE = true; // add functions of RxDocument\n\n  var docBaseProto = basePrototype;\n  var props = Object.getOwnPropertyNames(docBaseProto);\n  props.forEach(function (key) {\n    var exists = Object.getOwnPropertyDescriptor(RxLocalDocumentPrototype, key);\n    if (exists) return;\n    var desc = Object.getOwnPropertyDescriptor(docBaseProto, key);\n    Object.defineProperty(RxLocalDocumentPrototype, key, desc);\n  });\n  /**\n   * overwrite things that not work on local documents\n   * with throwing function\n   */\n\n  var getThrowingFun = function getThrowingFun(k) {\n    return function () {\n      throw newRxError('LD6', {\n        functionName: k\n      });\n    };\n  };\n\n  ['populate', 'update', 'putAttachment', 'getAttachment', 'allAttachments'].forEach(function (k) {\n    return RxLocalDocumentPrototype[k] = getThrowingFun(k);\n  });\n};\n\nRxLocalDocument.create = function (id, data, parent) {\n  _init();\n\n  _getChangeSub(parent);\n\n  var newDoc = new RxLocalDocument(id, data, parent);\n  newDoc.__proto__ = RxLocalDocumentPrototype;\n\n  _getDocCache(parent).set(id, newDoc);\n\n  return newDoc;\n};\n/**\n * save the local-document-data\n * throws if already exists\n */\n\n\nfunction insertLocal(id, data) {\n  var _this4 = this;\n\n  if (isRxCollection(this) && this._isInMemory) return this._parentCollection.insertLocal(id, data);\n  data = clone(data);\n  return this.getLocal(id).then(function (existing) {\n    if (existing) {\n      throw newRxError('LD7', {\n        id: id,\n        data: data\n      });\n    } // create new one\n\n\n    var pouch = _getPouchByParent(_this4);\n\n    var saveData = clone(data);\n    saveData._id = LOCAL_PREFIX + id;\n    return pouch.put(saveData);\n  }).then(function (res) {\n    data._rev = res.rev;\n    var newDoc = RxLocalDocument.create(id, data, _this4);\n    return newDoc;\n  });\n}\n/**\n * save the local-document-data\n * overwrites existing if exists\n */\n\n\nfunction upsertLocal(id, data) {\n  var _this5 = this;\n\n  if (isRxCollection(this) && this._isInMemory) return this._parentCollection.upsertLocal(id, data);\n  return this.getLocal(id).then(function (existing) {\n    if (!existing) {\n      // create new one\n      var doc = _this5.insertLocal(id, data);\n\n      return doc;\n    } else {\n      // update existing\n      data._rev = existing._data._rev;\n      return existing.atomicUpdate(function () {\n        return data;\n      }).then(function () {\n        return existing;\n      });\n    }\n  });\n}\n\nfunction getLocal(id) {\n  var _this6 = this;\n\n  if (isRxCollection(this) && this._isInMemory) return this._parentCollection.getLocal(id);\n\n  var pouch = _getPouchByParent(this);\n\n  var docCache = _getDocCache(this); // check in doc-cache\n\n\n  var found = docCache.get(id);\n  if (found) return Promise.resolve(found); // if not found, check in pouch\n\n  return pouch.get(LOCAL_PREFIX + id).then(function (docData) {\n    if (!docData) return null;\n    var doc = RxLocalDocument.create(id, docData, _this6);\n    return doc;\n  })[\"catch\"](function () {\n    return null;\n  });\n}\n\nexport var rxdb = true;\nexport var prototypes = {\n  RxCollection: function RxCollection(proto) {\n    proto.insertLocal = insertLocal;\n    proto.upsertLocal = upsertLocal;\n    proto.getLocal = getLocal;\n  },\n  RxDatabase: function RxDatabase(proto) {\n    proto.insertLocal = insertLocal;\n    proto.upsertLocal = upsertLocal;\n    proto.getLocal = getLocal;\n  }\n};\nexport var overwritable = {};\nexport default {\n  rxdb: rxdb,\n  prototypes: prototypes,\n  overwritable: overwritable\n};","map":{"version":3,"sources":["/Users/Hanzalah/Desktop/github/todo-offline/rxdb-hasura-demo/node_modules/rxdb/dist/es/plugins/local-documents.js"],"names":["_inheritsLoose","objectPath","createRxDocumentConstructor","basePrototype","createChangeEvent","createDocCache","newRxError","newRxTypeError","clone","isInstanceOf","isRxDatabase","isRxCollection","filter","map","distinctUntilChanged","DOC_CACHE_BY_PARENT","WeakMap","_getDocCache","parent","has","set","get","CHANGE_SUB_BY_PARENT","_getChangeSub","sub","$","pipe","cE","data","isLocal","subscribe","docCache","doc","_handleChangeEvent","_subs","push","LOCAL_PREFIX","RxDocumentParent","RxLocalDocument","_RxDocumentParent","id","jsonData","_this","call","_getPouchByParent","_adminPouch","pouch","RxLocalDocumentPrototype","toPouchJson","_data","_id","parentPouch","changeEvent","primary","op","newData","v","_dataSync$","next","_deleted$","allAttachments$","document","primaryPath","asObservable","$emit","objPath","undefined","valueObj","get$","path","includes","value","_rev","Object","is","_saveData","_this2","put","then","res","rev","database","remove","_this3","removeId","INIT_DONE","_init","docBaseProto","props","getOwnPropertyNames","forEach","key","exists","getOwnPropertyDescriptor","desc","defineProperty","getThrowingFun","k","functionName","create","newDoc","__proto__","insertLocal","_this4","_isInMemory","_parentCollection","getLocal","existing","saveData","upsertLocal","_this5","atomicUpdate","_this6","found","Promise","resolve","docData","rxdb","prototypes","RxCollection","proto","RxDatabase","overwritable"],"mappings":"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","sourcesContent":["import _inheritsLoose from \"@babel/runtime/helpers/inheritsLoose\";\n\n/**\n * This plugin adds the local-documents-support\n * Local documents behave equal then with pouchdb\n * @link https://pouchdb.com/guides/local-documents.html\n */\nimport objectPath from 'object-path';\nimport { createRxDocumentConstructor, basePrototype } from '../rx-document';\nimport { createChangeEvent } from '../rx-change-event';\nimport { createDocCache } from '../doc-cache';\nimport { newRxError, newRxTypeError } from '../rx-error';\nimport { clone } from '../util';\nimport { isInstanceOf as isRxDatabase } from '../rx-database';\nimport { isInstanceOf as isRxCollection } from '../rx-collection';\nimport { filter, map, distinctUntilChanged } from 'rxjs/operators';\nvar DOC_CACHE_BY_PARENT = new WeakMap();\n\nvar _getDocCache = function _getDocCache(parent) {\n  if (!DOC_CACHE_BY_PARENT.has(parent)) {\n    DOC_CACHE_BY_PARENT.set(parent, createDocCache());\n  }\n\n  return DOC_CACHE_BY_PARENT.get(parent);\n};\n\nvar CHANGE_SUB_BY_PARENT = new WeakMap();\n\nvar _getChangeSub = function _getChangeSub(parent) {\n  if (!CHANGE_SUB_BY_PARENT.has(parent)) {\n    var sub = parent.$.pipe(filter(function (cE) {\n      return cE.data.isLocal;\n    })).subscribe(function (cE) {\n      var docCache = _getDocCache(parent);\n\n      var doc = docCache.get(cE.data.doc);\n      if (doc) doc._handleChangeEvent(cE);\n    });\n\n    parent._subs.push(sub);\n\n    CHANGE_SUB_BY_PARENT.set(parent, sub);\n  }\n\n  return CHANGE_SUB_BY_PARENT.get(parent);\n};\n\nvar LOCAL_PREFIX = '_local/';\nvar RxDocumentParent = createRxDocumentConstructor();\nexport var RxLocalDocument = /*#__PURE__*/function (_RxDocumentParent) {\n  _inheritsLoose(RxLocalDocument, _RxDocumentParent);\n\n  function RxLocalDocument(id, jsonData, parent) {\n    var _this;\n\n    _this = _RxDocumentParent.call(this, null, jsonData) || this;\n    _this.id = id;\n    _this.parent = parent;\n    return _this;\n  }\n\n  return RxLocalDocument;\n}(RxDocumentParent);\n\nvar _getPouchByParent = function _getPouchByParent(parent) {\n  if (isRxDatabase(parent)) return parent._adminPouch; // database\n  else return parent.pouch; // collection\n};\n\nvar RxLocalDocumentPrototype = {\n  toPouchJson: function toPouchJson() {\n    var data = clone(this._data);\n    data._id = LOCAL_PREFIX + this.id;\n  },\n\n  get isLocal() {\n    return true;\n  },\n\n  get parentPouch() {\n    return _getPouchByParent(this.parent);\n  },\n\n  //\n  // overwrites\n  //\n  _handleChangeEvent: function _handleChangeEvent(changeEvent) {\n    if (changeEvent.data.doc !== this.primary) return;\n\n    switch (changeEvent.data.op) {\n      case 'UPDATE':\n        var newData = clone(changeEvent.data.v);\n\n        this._dataSync$.next(clone(newData));\n\n        break;\n\n      case 'REMOVE':\n        // remove from docCache to assure new upserted RxDocuments will be a new instance\n        var docCache = _getDocCache(this.parent);\n\n        docCache[\"delete\"](this.primary);\n\n        this._deleted$.next(true);\n\n        break;\n    }\n  },\n\n  get allAttachments$() {\n    // this is overwritten here because we cannot re-set getters on the prototype\n    throw newRxError('LD1', {\n      document: this\n    });\n  },\n\n  get primaryPath() {\n    return 'id';\n  },\n\n  get primary() {\n    return this.id;\n  },\n\n  get $() {\n    return this._dataSync$.asObservable();\n  },\n\n  $emit: function $emit(changeEvent) {\n    return this.parent.$emit(changeEvent);\n  },\n  get: function get(objPath) {\n    if (!this._data) return undefined;\n\n    if (typeof objPath !== 'string') {\n      throw newRxTypeError('LD2', {\n        objPath: objPath\n      });\n    }\n\n    var valueObj = objectPath.get(this._data, objPath);\n    valueObj = clone(valueObj);\n    return valueObj;\n  },\n  get$: function get$(path) {\n    if (path.includes('.item.')) {\n      throw newRxError('LD3', {\n        path: path\n      });\n    }\n\n    if (path === this.primaryPath) throw newRxError('LD4');\n    return this._dataSync$.pipe(map(function (data) {\n      return objectPath.get(data, path);\n    }), distinctUntilChanged());\n  },\n  set: function set(objPath, value) {\n    if (!value) {\n      // object path not set, overwrite whole data\n      var data = clone(objPath);\n      data._rev = this._data._rev;\n      this._data = data;\n      return this;\n    }\n\n    if (objPath === '_id') {\n      throw newRxError('LD5', {\n        objPath: objPath,\n        value: value\n      });\n    }\n\n    if (Object.is(this.get(objPath), value)) return;\n    objectPath.set(this._data, objPath, value);\n    return this;\n  },\n  _saveData: function _saveData(newData) {\n    var _this2 = this;\n\n    newData = clone(newData);\n    newData._id = LOCAL_PREFIX + this.id;\n    return this.parentPouch.put(newData).then(function (res) {\n      newData._rev = res.rev;\n\n      _this2._dataSync$.next(newData);\n\n      var changeEvent = createChangeEvent('UPDATE', isRxDatabase(_this2.parent) ? _this2.parent : _this2.parent.database, isRxCollection(_this2.parent) ? _this2.parent : null, _this2, clone(_this2._data), true);\n\n      _this2.$emit(changeEvent);\n    });\n  },\n  remove: function remove() {\n    var _this3 = this;\n\n    var removeId = LOCAL_PREFIX + this.id;\n    return this.parentPouch.remove(removeId, this._data._rev).then(function () {\n      _getDocCache(_this3.parent)[\"delete\"](_this3.id);\n\n      var changeEvent = createChangeEvent('REMOVE', isRxDatabase(_this3.parent) ? _this3.parent : _this3.parent.database, isRxCollection(_this3.parent) ? _this3.parent : null, _this3, clone(_this3._data), true);\n\n      _this3.$emit(changeEvent);\n    });\n  }\n};\nvar INIT_DONE = false;\n\nvar _init = function _init() {\n  if (INIT_DONE) return;else INIT_DONE = true; // add functions of RxDocument\n\n  var docBaseProto = basePrototype;\n  var props = Object.getOwnPropertyNames(docBaseProto);\n  props.forEach(function (key) {\n    var exists = Object.getOwnPropertyDescriptor(RxLocalDocumentPrototype, key);\n    if (exists) return;\n    var desc = Object.getOwnPropertyDescriptor(docBaseProto, key);\n    Object.defineProperty(RxLocalDocumentPrototype, key, desc);\n  });\n  /**\n   * overwrite things that not work on local documents\n   * with throwing function\n   */\n\n  var getThrowingFun = function getThrowingFun(k) {\n    return function () {\n      throw newRxError('LD6', {\n        functionName: k\n      });\n    };\n  };\n\n  ['populate', 'update', 'putAttachment', 'getAttachment', 'allAttachments'].forEach(function (k) {\n    return RxLocalDocumentPrototype[k] = getThrowingFun(k);\n  });\n};\n\nRxLocalDocument.create = function (id, data, parent) {\n  _init();\n\n  _getChangeSub(parent);\n\n  var newDoc = new RxLocalDocument(id, data, parent);\n  newDoc.__proto__ = RxLocalDocumentPrototype;\n\n  _getDocCache(parent).set(id, newDoc);\n\n  return newDoc;\n};\n/**\n * save the local-document-data\n * throws if already exists\n */\n\n\nfunction insertLocal(id, data) {\n  var _this4 = this;\n\n  if (isRxCollection(this) && this._isInMemory) return this._parentCollection.insertLocal(id, data);\n  data = clone(data);\n  return this.getLocal(id).then(function (existing) {\n    if (existing) {\n      throw newRxError('LD7', {\n        id: id,\n        data: data\n      });\n    } // create new one\n\n\n    var pouch = _getPouchByParent(_this4);\n\n    var saveData = clone(data);\n    saveData._id = LOCAL_PREFIX + id;\n    return pouch.put(saveData);\n  }).then(function (res) {\n    data._rev = res.rev;\n    var newDoc = RxLocalDocument.create(id, data, _this4);\n    return newDoc;\n  });\n}\n/**\n * save the local-document-data\n * overwrites existing if exists\n */\n\n\nfunction upsertLocal(id, data) {\n  var _this5 = this;\n\n  if (isRxCollection(this) && this._isInMemory) return this._parentCollection.upsertLocal(id, data);\n  return this.getLocal(id).then(function (existing) {\n    if (!existing) {\n      // create new one\n      var doc = _this5.insertLocal(id, data);\n\n      return doc;\n    } else {\n      // update existing\n      data._rev = existing._data._rev;\n      return existing.atomicUpdate(function () {\n        return data;\n      }).then(function () {\n        return existing;\n      });\n    }\n  });\n}\n\nfunction getLocal(id) {\n  var _this6 = this;\n\n  if (isRxCollection(this) && this._isInMemory) return this._parentCollection.getLocal(id);\n\n  var pouch = _getPouchByParent(this);\n\n  var docCache = _getDocCache(this); // check in doc-cache\n\n\n  var found = docCache.get(id);\n  if (found) return Promise.resolve(found); // if not found, check in pouch\n\n  return pouch.get(LOCAL_PREFIX + id).then(function (docData) {\n    if (!docData) return null;\n    var doc = RxLocalDocument.create(id, docData, _this6);\n    return doc;\n  })[\"catch\"](function () {\n    return null;\n  });\n}\n\nexport var rxdb = true;\nexport var prototypes = {\n  RxCollection: function RxCollection(proto) {\n    proto.insertLocal = insertLocal;\n    proto.upsertLocal = upsertLocal;\n    proto.getLocal = getLocal;\n  },\n  RxDatabase: function RxDatabase(proto) {\n    proto.insertLocal = insertLocal;\n    proto.upsertLocal = upsertLocal;\n    proto.getLocal = getLocal;\n  }\n};\nexport var overwritable = {};\nexport default {\n  rxdb: rxdb,\n  prototypes: prototypes,\n  overwritable: overwritable\n};\n//# sourceMappingURL=local-documents.js.map"]},"metadata":{},"sourceType":"module"}