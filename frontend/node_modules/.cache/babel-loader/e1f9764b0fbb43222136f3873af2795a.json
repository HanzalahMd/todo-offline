{"ast":null,"code":"import _regeneratorRuntime from \"@babel/runtime/regenerator\";\nimport _asyncToGenerator from \"@babel/runtime/helpers/asyncToGenerator\";\nimport _inheritsLoose from \"@babel/runtime/helpers/inheritsLoose\";\n/**\n * This plugin adds the local-documents-support\n * Local documents behave equal then with pouchdb\n * @link https://pouchdb.com/guides/local-documents.html\n */\n\nimport objectPath from 'object-path';\nimport { createRxDocumentConstructor, basePrototype } from '../rx-document';\nimport { RxChangeEvent } from '../rx-change-event';\nimport { createDocCache } from '../doc-cache';\nimport { newRxError, newRxTypeError } from '../rx-error';\nimport { clone, now, LOCAL_PREFIX } from '../util';\nimport { isInstanceOf as isRxDatabase } from '../rx-database';\nimport { isInstanceOf as isRxCollection } from '../rx-collection';\nimport { filter, map, distinctUntilChanged, startWith, mergeMap } from 'rxjs/operators';\nvar DOC_CACHE_BY_PARENT = new WeakMap();\n\nvar _getDocCache = function _getDocCache(parent) {\n  if (!DOC_CACHE_BY_PARENT.has(parent)) {\n    DOC_CACHE_BY_PARENT.set(parent, createDocCache());\n  }\n\n  return DOC_CACHE_BY_PARENT.get(parent);\n};\n\nvar CHANGE_SUB_BY_PARENT = new WeakMap();\n\nvar _getChangeSub = function _getChangeSub(parent) {\n  if (!CHANGE_SUB_BY_PARENT.has(parent)) {\n    var sub = parent.$.pipe(filter(function (cE) {\n      return cE.isLocal;\n    })).subscribe(function (cE) {\n      var docCache = _getDocCache(parent);\n\n      var doc = docCache.get(cE.documentId);\n      if (doc) doc._handleChangeEvent(cE);\n    });\n\n    parent._subs.push(sub);\n\n    CHANGE_SUB_BY_PARENT.set(parent, sub);\n  }\n\n  return CHANGE_SUB_BY_PARENT.get(parent);\n};\n\nvar RxDocumentParent = createRxDocumentConstructor();\nexport var RxLocalDocument =\n/*#__PURE__*/\nfunction (_RxDocumentParent) {\n  _inheritsLoose(RxLocalDocument, _RxDocumentParent);\n\n  function RxLocalDocument(id, jsonData, parent) {\n    var _this;\n\n    _this = _RxDocumentParent.call(this, null, jsonData) || this;\n    _this.id = id;\n    _this.parent = parent;\n    return _this;\n  }\n\n  return RxLocalDocument;\n}(RxDocumentParent);\n\nvar _getPouchByParent = function _getPouchByParent(parent) {\n  if (isRxDatabase(parent)) return parent.internalStore; // database\n  else return parent.pouch; // collection\n};\n\nvar RxLocalDocumentPrototype = {\n  toPouchJson: function toPouchJson() {\n    var data = clone(this._data);\n    data._id = LOCAL_PREFIX + this.id;\n  },\n\n  get isLocal() {\n    return true;\n  },\n\n  get parentPouch() {\n    return _getPouchByParent(this.parent);\n  },\n\n  //\n  // overwrites\n  //\n  _handleChangeEvent: function _handleChangeEvent(changeEvent) {\n    if (changeEvent.documentId !== this.primary) {\n      return;\n    }\n\n    switch (changeEvent.operation) {\n      case 'UPDATE':\n        var newData = clone(changeEvent.documentData);\n\n        this._dataSync$.next(clone(newData));\n\n        break;\n\n      case 'DELETE':\n        // remove from docCache to assure new upserted RxDocuments will be a new instance\n        var docCache = _getDocCache(this.parent);\n\n        docCache[\"delete\"](this.primary);\n\n        this._deleted$.next(true);\n\n        break;\n    }\n  },\n\n  get allAttachments$() {\n    // this is overwritten here because we cannot re-set getters on the prototype\n    throw newRxError('LD1', {\n      document: this\n    });\n  },\n\n  get primaryPath() {\n    return 'id';\n  },\n\n  get primary() {\n    return this.id;\n  },\n\n  get $() {\n    return this._dataSync$.asObservable();\n  },\n\n  $emit: function $emit(changeEvent) {\n    return this.parent.$emit(changeEvent);\n  },\n  get: function get(objPath) {\n    if (!this._data) return undefined;\n\n    if (typeof objPath !== 'string') {\n      throw newRxTypeError('LD2', {\n        objPath: objPath\n      });\n    }\n\n    var valueObj = objectPath.get(this._data, objPath);\n    valueObj = clone(valueObj);\n    return valueObj;\n  },\n  get$: function get$(path) {\n    if (path.includes('.item.')) {\n      throw newRxError('LD3', {\n        path: path\n      });\n    }\n\n    if (path === this.primaryPath) throw newRxError('LD4');\n    return this._dataSync$.pipe(map(function (data) {\n      return objectPath.get(data, path);\n    }), distinctUntilChanged());\n  },\n  set: function set(objPath, value) {\n    if (!value) {\n      // object path not set, overwrite whole data\n      var data = clone(objPath);\n      data._rev = this._data._rev;\n      this._data = data;\n      return this;\n    }\n\n    if (objPath === '_id') {\n      throw newRxError('LD5', {\n        objPath: objPath,\n        value: value\n      });\n    }\n\n    if (Object.is(this.get(objPath), value)) return;\n    objectPath.set(this._data, objPath, value);\n    return this;\n  },\n  _saveData: function _saveData(newData) {\n    var _this2 = this;\n\n    var oldData = this._dataSync$.getValue();\n\n    newData = clone(newData);\n    newData._id = LOCAL_PREFIX + this.id;\n    var startTime = now();\n    return this.parentPouch.put(newData).then(function (res) {\n      var endTime = now();\n      newData._rev = res.rev;\n      var changeEvent = new RxChangeEvent('UPDATE', _this2.id, clone(newData), isRxDatabase(_this2.parent) ? _this2.parent.token : _this2.parent.database.token, isRxCollection(_this2.parent) ? _this2.parent.name : null, true, startTime, endTime, oldData, _this2);\n\n      _this2.$emit(changeEvent);\n    });\n  },\n  remove: function remove() {\n    var _this3 = this;\n\n    var removeId = LOCAL_PREFIX + this.id;\n    var startTime = now();\n    return this.parentPouch.remove(removeId, this._data._rev).then(function () {\n      _getDocCache(_this3.parent)[\"delete\"](_this3.id);\n\n      var endTime = now();\n      var changeEvent = new RxChangeEvent('DELETE', _this3.id, clone(_this3._data), isRxDatabase(_this3.parent) ? _this3.parent.token : _this3.parent.database.token, isRxCollection(_this3.parent) ? _this3.parent.name : null, true, startTime, endTime, null, _this3);\n\n      _this3.$emit(changeEvent);\n    });\n  }\n};\nvar INIT_DONE = false;\n\nvar _init = function _init() {\n  if (INIT_DONE) return;else INIT_DONE = true; // add functions of RxDocument\n\n  var docBaseProto = basePrototype;\n  var props = Object.getOwnPropertyNames(docBaseProto);\n  props.forEach(function (key) {\n    var exists = Object.getOwnPropertyDescriptor(RxLocalDocumentPrototype, key);\n    if (exists) return;\n    var desc = Object.getOwnPropertyDescriptor(docBaseProto, key);\n    Object.defineProperty(RxLocalDocumentPrototype, key, desc);\n  });\n  /**\n   * overwrite things that not work on local documents\n   * with throwing function\n   */\n\n  var getThrowingFun = function getThrowingFun(k) {\n    return function () {\n      throw newRxError('LD6', {\n        functionName: k\n      });\n    };\n  };\n\n  ['populate', 'update', 'putAttachment', 'getAttachment', 'allAttachments'].forEach(function (k) {\n    return RxLocalDocumentPrototype[k] = getThrowingFun(k);\n  });\n};\n\nRxLocalDocument.create = function (id, data, parent) {\n  _init();\n\n  _getChangeSub(parent);\n\n  var newDoc = new RxLocalDocument(id, data, parent);\n  newDoc.__proto__ = RxLocalDocumentPrototype;\n\n  _getDocCache(parent).set(id, newDoc);\n\n  return newDoc;\n};\n/**\n * save the local-document-data\n * throws if already exists\n */\n\n\nfunction insertLocal(id, data) {\n  var _this4 = this;\n\n  if (isRxCollection(this) && this._isInMemory) {\n    return this._parentCollection.insertLocal(id, data);\n  }\n\n  data = clone(data);\n  return this.getLocal(id).then(function (existing) {\n    if (existing) {\n      throw newRxError('LD7', {\n        id: id,\n        data: data\n      });\n    } // create new one\n\n\n    var pouch = _getPouchByParent(_this4);\n\n    var saveData = clone(data);\n    saveData._id = LOCAL_PREFIX + id;\n    var startTime = now();\n    return pouch.put(saveData).then(function (res) {\n      data._rev = res.rev;\n      var newDoc = RxLocalDocument.create(id, data, _this4);\n      var endTime = now();\n      var changeEvent = new RxChangeEvent('INSERT', id, clone(data), isRxDatabase(_this4) ? _this4.token : _this4.database.token, isRxCollection(_this4) ? _this4.name : '', true, startTime, endTime, undefined, newDoc);\n\n      _this4.$emit(changeEvent);\n\n      return newDoc;\n    });\n  });\n}\n/**\n * save the local-document-data\n * overwrites existing if exists\n */\n\n\nfunction upsertLocal(id, data) {\n  var _this5 = this;\n\n  if (isRxCollection(this) && this._isInMemory) {\n    return this._parentCollection.upsertLocal(id, data);\n  }\n\n  return this.getLocal(id).then(function (existing) {\n    if (!existing) {\n      // create new one\n      var docPromise = _this5.insertLocal(id, data);\n\n      return docPromise;\n    } else {\n      // update existing\n      data._rev = existing._data._rev;\n      return existing.atomicUpdate(function () {\n        return data;\n      }).then(function () {\n        return existing;\n      });\n    }\n  });\n}\n\nfunction getLocal(id) {\n  var _this6 = this;\n\n  if (isRxCollection(this) && this._isInMemory) return this._parentCollection.getLocal(id);\n\n  var pouch = _getPouchByParent(this);\n\n  var docCache = _getDocCache(this); // check in doc-cache\n\n\n  var found = docCache.get(id);\n  if (found) return Promise.resolve(found); // if not found, check in pouch\n\n  return pouch.get(LOCAL_PREFIX + id).then(function (docData) {\n    if (!docData) return null;\n    var doc = RxLocalDocument.create(id, docData, _this6);\n    return doc;\n  })[\"catch\"](function () {\n    return null;\n  });\n}\n\nfunction getLocal$(id) {\n  var _this7 = this;\n\n  return this.$.pipe(startWith(null), mergeMap(\n  /*#__PURE__*/\n  function () {\n    var _ref = _asyncToGenerator(\n    /*#__PURE__*/\n    _regeneratorRuntime.mark(function _callee(cE) {\n      var doc;\n      return _regeneratorRuntime.wrap(function _callee$(_context) {\n        while (1) {\n          switch (_context.prev = _context.next) {\n            case 0:\n              if (!cE) {\n                _context.next = 4;\n                break;\n              }\n\n              return _context.abrupt(\"return\", {\n                changeEvent: cE\n              });\n\n            case 4:\n              _context.next = 6;\n              return _this7.getLocal(id);\n\n            case 6:\n              doc = _context.sent;\n              return _context.abrupt(\"return\", {\n                doc: doc\n              });\n\n            case 8:\n            case \"end\":\n              return _context.stop();\n          }\n        }\n      }, _callee);\n    }));\n\n    return function (_x) {\n      return _ref.apply(this, arguments);\n    };\n  }()), mergeMap(\n  /*#__PURE__*/\n  function () {\n    var _ref2 = _asyncToGenerator(\n    /*#__PURE__*/\n    _regeneratorRuntime.mark(function _callee2(changeEventOrDoc) {\n      var cE, doc;\n      return _regeneratorRuntime.wrap(function _callee2$(_context2) {\n        while (1) {\n          switch (_context2.prev = _context2.next) {\n            case 0:\n              if (!changeEventOrDoc.changeEvent) {\n                _context2.next = 17;\n                break;\n              }\n\n              cE = changeEventOrDoc.changeEvent;\n\n              if (!(!cE.isLocal || cE.documentId !== id)) {\n                _context2.next = 6;\n                break;\n              }\n\n              return _context2.abrupt(\"return\", {\n                use: false\n              });\n\n            case 6:\n              if (!cE.rxDocument) {\n                _context2.next = 10;\n                break;\n              }\n\n              _context2.t0 = cE.rxDocument;\n              _context2.next = 13;\n              break;\n\n            case 10:\n              _context2.next = 12;\n              return _this7.getLocal(id);\n\n            case 12:\n              _context2.t0 = _context2.sent;\n\n            case 13:\n              doc = _context2.t0;\n              return _context2.abrupt(\"return\", {\n                use: true,\n                doc: doc\n              });\n\n            case 15:\n              _context2.next = 18;\n              break;\n\n            case 17:\n              return _context2.abrupt(\"return\", {\n                use: true,\n                doc: changeEventOrDoc.doc\n              });\n\n            case 18:\n            case \"end\":\n              return _context2.stop();\n          }\n        }\n      }, _callee2);\n    }));\n\n    return function (_x2) {\n      return _ref2.apply(this, arguments);\n    };\n  }()), filter(function (filterFlagged) {\n    return filterFlagged.use;\n  }), map(function (filterFlagged) {\n    return filterFlagged.doc;\n  }));\n}\n\nexport var rxdb = true;\nexport var prototypes = {\n  RxCollection: function RxCollection(proto) {\n    proto.insertLocal = insertLocal;\n    proto.upsertLocal = upsertLocal;\n    proto.getLocal = getLocal;\n    proto.getLocal$ = getLocal$;\n  },\n  RxDatabase: function RxDatabase(proto) {\n    proto.insertLocal = insertLocal;\n    proto.upsertLocal = upsertLocal;\n    proto.getLocal = getLocal;\n    proto.getLocal$ = getLocal$;\n  }\n};\nexport var overwritable = {};\nexport var RxDBLocalDocumentsPlugin = {\n  name: 'local-documents',\n  rxdb: rxdb,\n  prototypes: prototypes,\n  overwritable: overwritable\n};","map":{"version":3,"sources":["/Users/Hanzalah/Desktop/github/todo-offline/rxdb-hasura-demo/node_modules/rxdb/dist/es/plugins/local-documents.js"],"names":["_regeneratorRuntime","_asyncToGenerator","_inheritsLoose","objectPath","createRxDocumentConstructor","basePrototype","RxChangeEvent","createDocCache","newRxError","newRxTypeError","clone","now","LOCAL_PREFIX","isInstanceOf","isRxDatabase","isRxCollection","filter","map","distinctUntilChanged","startWith","mergeMap","DOC_CACHE_BY_PARENT","WeakMap","_getDocCache","parent","has","set","get","CHANGE_SUB_BY_PARENT","_getChangeSub","sub","$","pipe","cE","isLocal","subscribe","docCache","doc","documentId","_handleChangeEvent","_subs","push","RxDocumentParent","RxLocalDocument","_RxDocumentParent","id","jsonData","_this","call","_getPouchByParent","internalStore","pouch","RxLocalDocumentPrototype","toPouchJson","data","_data","_id","parentPouch","changeEvent","primary","operation","newData","documentData","_dataSync$","next","_deleted$","allAttachments$","document","primaryPath","asObservable","$emit","objPath","undefined","valueObj","get$","path","includes","value","_rev","Object","is","_saveData","_this2","oldData","getValue","startTime","put","then","res","endTime","rev","token","database","name","remove","_this3","removeId","INIT_DONE","_init","docBaseProto","props","getOwnPropertyNames","forEach","key","exists","getOwnPropertyDescriptor","desc","defineProperty","getThrowingFun","k","functionName","create","newDoc","__proto__","insertLocal","_this4","_isInMemory","_parentCollection","getLocal","existing","saveData","upsertLocal","_this5","docPromise","atomicUpdate","_this6","found","Promise","resolve","docData","getLocal$","_this7","_ref","mark","_callee","wrap","_callee$","_context","prev","abrupt","sent","stop","_x","apply","arguments","_ref2","_callee2","changeEventOrDoc","_callee2$","_context2","use","rxDocument","t0","_x2","filterFlagged","rxdb","prototypes","RxCollection","proto","RxDatabase","overwritable","RxDBLocalDocumentsPlugin"],"mappings":"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","sourcesContent":["import _regeneratorRuntime from \"@babel/runtime/regenerator\";\nimport _asyncToGenerator from \"@babel/runtime/helpers/asyncToGenerator\";\nimport _inheritsLoose from \"@babel/runtime/helpers/inheritsLoose\";\n\n/**\n * This plugin adds the local-documents-support\n * Local documents behave equal then with pouchdb\n * @link https://pouchdb.com/guides/local-documents.html\n */\nimport objectPath from 'object-path';\nimport { createRxDocumentConstructor, basePrototype } from '../rx-document';\nimport { RxChangeEvent } from '../rx-change-event';\nimport { createDocCache } from '../doc-cache';\nimport { newRxError, newRxTypeError } from '../rx-error';\nimport { clone, now, LOCAL_PREFIX } from '../util';\nimport { isInstanceOf as isRxDatabase } from '../rx-database';\nimport { isInstanceOf as isRxCollection } from '../rx-collection';\nimport { filter, map, distinctUntilChanged, startWith, mergeMap } from 'rxjs/operators';\nvar DOC_CACHE_BY_PARENT = new WeakMap();\n\nvar _getDocCache = function _getDocCache(parent) {\n  if (!DOC_CACHE_BY_PARENT.has(parent)) {\n    DOC_CACHE_BY_PARENT.set(parent, createDocCache());\n  }\n\n  return DOC_CACHE_BY_PARENT.get(parent);\n};\n\nvar CHANGE_SUB_BY_PARENT = new WeakMap();\n\nvar _getChangeSub = function _getChangeSub(parent) {\n  if (!CHANGE_SUB_BY_PARENT.has(parent)) {\n    var sub = parent.$.pipe(filter(function (cE) {\n      return cE.isLocal;\n    })).subscribe(function (cE) {\n      var docCache = _getDocCache(parent);\n\n      var doc = docCache.get(cE.documentId);\n      if (doc) doc._handleChangeEvent(cE);\n    });\n\n    parent._subs.push(sub);\n\n    CHANGE_SUB_BY_PARENT.set(parent, sub);\n  }\n\n  return CHANGE_SUB_BY_PARENT.get(parent);\n};\n\nvar RxDocumentParent = createRxDocumentConstructor();\nexport var RxLocalDocument = /*#__PURE__*/function (_RxDocumentParent) {\n  _inheritsLoose(RxLocalDocument, _RxDocumentParent);\n\n  function RxLocalDocument(id, jsonData, parent) {\n    var _this;\n\n    _this = _RxDocumentParent.call(this, null, jsonData) || this;\n    _this.id = id;\n    _this.parent = parent;\n    return _this;\n  }\n\n  return RxLocalDocument;\n}(RxDocumentParent);\n\nvar _getPouchByParent = function _getPouchByParent(parent) {\n  if (isRxDatabase(parent)) return parent.internalStore; // database\n  else return parent.pouch; // collection\n};\n\nvar RxLocalDocumentPrototype = {\n  toPouchJson: function toPouchJson() {\n    var data = clone(this._data);\n    data._id = LOCAL_PREFIX + this.id;\n  },\n\n  get isLocal() {\n    return true;\n  },\n\n  get parentPouch() {\n    return _getPouchByParent(this.parent);\n  },\n\n  //\n  // overwrites\n  //\n  _handleChangeEvent: function _handleChangeEvent(changeEvent) {\n    if (changeEvent.documentId !== this.primary) {\n      return;\n    }\n\n    switch (changeEvent.operation) {\n      case 'UPDATE':\n        var newData = clone(changeEvent.documentData);\n\n        this._dataSync$.next(clone(newData));\n\n        break;\n\n      case 'DELETE':\n        // remove from docCache to assure new upserted RxDocuments will be a new instance\n        var docCache = _getDocCache(this.parent);\n\n        docCache[\"delete\"](this.primary);\n\n        this._deleted$.next(true);\n\n        break;\n    }\n  },\n\n  get allAttachments$() {\n    // this is overwritten here because we cannot re-set getters on the prototype\n    throw newRxError('LD1', {\n      document: this\n    });\n  },\n\n  get primaryPath() {\n    return 'id';\n  },\n\n  get primary() {\n    return this.id;\n  },\n\n  get $() {\n    return this._dataSync$.asObservable();\n  },\n\n  $emit: function $emit(changeEvent) {\n    return this.parent.$emit(changeEvent);\n  },\n  get: function get(objPath) {\n    if (!this._data) return undefined;\n\n    if (typeof objPath !== 'string') {\n      throw newRxTypeError('LD2', {\n        objPath: objPath\n      });\n    }\n\n    var valueObj = objectPath.get(this._data, objPath);\n    valueObj = clone(valueObj);\n    return valueObj;\n  },\n  get$: function get$(path) {\n    if (path.includes('.item.')) {\n      throw newRxError('LD3', {\n        path: path\n      });\n    }\n\n    if (path === this.primaryPath) throw newRxError('LD4');\n    return this._dataSync$.pipe(map(function (data) {\n      return objectPath.get(data, path);\n    }), distinctUntilChanged());\n  },\n  set: function set(objPath, value) {\n    if (!value) {\n      // object path not set, overwrite whole data\n      var data = clone(objPath);\n      data._rev = this._data._rev;\n      this._data = data;\n      return this;\n    }\n\n    if (objPath === '_id') {\n      throw newRxError('LD5', {\n        objPath: objPath,\n        value: value\n      });\n    }\n\n    if (Object.is(this.get(objPath), value)) return;\n    objectPath.set(this._data, objPath, value);\n    return this;\n  },\n  _saveData: function _saveData(newData) {\n    var _this2 = this;\n\n    var oldData = this._dataSync$.getValue();\n\n    newData = clone(newData);\n    newData._id = LOCAL_PREFIX + this.id;\n    var startTime = now();\n    return this.parentPouch.put(newData).then(function (res) {\n      var endTime = now();\n      newData._rev = res.rev;\n      var changeEvent = new RxChangeEvent('UPDATE', _this2.id, clone(newData), isRxDatabase(_this2.parent) ? _this2.parent.token : _this2.parent.database.token, isRxCollection(_this2.parent) ? _this2.parent.name : null, true, startTime, endTime, oldData, _this2);\n\n      _this2.$emit(changeEvent);\n    });\n  },\n  remove: function remove() {\n    var _this3 = this;\n\n    var removeId = LOCAL_PREFIX + this.id;\n    var startTime = now();\n    return this.parentPouch.remove(removeId, this._data._rev).then(function () {\n      _getDocCache(_this3.parent)[\"delete\"](_this3.id);\n\n      var endTime = now();\n      var changeEvent = new RxChangeEvent('DELETE', _this3.id, clone(_this3._data), isRxDatabase(_this3.parent) ? _this3.parent.token : _this3.parent.database.token, isRxCollection(_this3.parent) ? _this3.parent.name : null, true, startTime, endTime, null, _this3);\n\n      _this3.$emit(changeEvent);\n    });\n  }\n};\nvar INIT_DONE = false;\n\nvar _init = function _init() {\n  if (INIT_DONE) return;else INIT_DONE = true; // add functions of RxDocument\n\n  var docBaseProto = basePrototype;\n  var props = Object.getOwnPropertyNames(docBaseProto);\n  props.forEach(function (key) {\n    var exists = Object.getOwnPropertyDescriptor(RxLocalDocumentPrototype, key);\n    if (exists) return;\n    var desc = Object.getOwnPropertyDescriptor(docBaseProto, key);\n    Object.defineProperty(RxLocalDocumentPrototype, key, desc);\n  });\n  /**\n   * overwrite things that not work on local documents\n   * with throwing function\n   */\n\n  var getThrowingFun = function getThrowingFun(k) {\n    return function () {\n      throw newRxError('LD6', {\n        functionName: k\n      });\n    };\n  };\n\n  ['populate', 'update', 'putAttachment', 'getAttachment', 'allAttachments'].forEach(function (k) {\n    return RxLocalDocumentPrototype[k] = getThrowingFun(k);\n  });\n};\n\nRxLocalDocument.create = function (id, data, parent) {\n  _init();\n\n  _getChangeSub(parent);\n\n  var newDoc = new RxLocalDocument(id, data, parent);\n  newDoc.__proto__ = RxLocalDocumentPrototype;\n\n  _getDocCache(parent).set(id, newDoc);\n\n  return newDoc;\n};\n/**\n * save the local-document-data\n * throws if already exists\n */\n\n\nfunction insertLocal(id, data) {\n  var _this4 = this;\n\n  if (isRxCollection(this) && this._isInMemory) {\n    return this._parentCollection.insertLocal(id, data);\n  }\n\n  data = clone(data);\n  return this.getLocal(id).then(function (existing) {\n    if (existing) {\n      throw newRxError('LD7', {\n        id: id,\n        data: data\n      });\n    } // create new one\n\n\n    var pouch = _getPouchByParent(_this4);\n\n    var saveData = clone(data);\n    saveData._id = LOCAL_PREFIX + id;\n    var startTime = now();\n    return pouch.put(saveData).then(function (res) {\n      data._rev = res.rev;\n      var newDoc = RxLocalDocument.create(id, data, _this4);\n      var endTime = now();\n      var changeEvent = new RxChangeEvent('INSERT', id, clone(data), isRxDatabase(_this4) ? _this4.token : _this4.database.token, isRxCollection(_this4) ? _this4.name : '', true, startTime, endTime, undefined, newDoc);\n\n      _this4.$emit(changeEvent);\n\n      return newDoc;\n    });\n  });\n}\n/**\n * save the local-document-data\n * overwrites existing if exists\n */\n\n\nfunction upsertLocal(id, data) {\n  var _this5 = this;\n\n  if (isRxCollection(this) && this._isInMemory) {\n    return this._parentCollection.upsertLocal(id, data);\n  }\n\n  return this.getLocal(id).then(function (existing) {\n    if (!existing) {\n      // create new one\n      var docPromise = _this5.insertLocal(id, data);\n\n      return docPromise;\n    } else {\n      // update existing\n      data._rev = existing._data._rev;\n      return existing.atomicUpdate(function () {\n        return data;\n      }).then(function () {\n        return existing;\n      });\n    }\n  });\n}\n\nfunction getLocal(id) {\n  var _this6 = this;\n\n  if (isRxCollection(this) && this._isInMemory) return this._parentCollection.getLocal(id);\n\n  var pouch = _getPouchByParent(this);\n\n  var docCache = _getDocCache(this); // check in doc-cache\n\n\n  var found = docCache.get(id);\n  if (found) return Promise.resolve(found); // if not found, check in pouch\n\n  return pouch.get(LOCAL_PREFIX + id).then(function (docData) {\n    if (!docData) return null;\n    var doc = RxLocalDocument.create(id, docData, _this6);\n    return doc;\n  })[\"catch\"](function () {\n    return null;\n  });\n}\n\nfunction getLocal$(id) {\n  var _this7 = this;\n\n  return this.$.pipe(startWith(null), mergeMap( /*#__PURE__*/function () {\n    var _ref = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee(cE) {\n      var doc;\n      return _regeneratorRuntime.wrap(function _callee$(_context) {\n        while (1) {\n          switch (_context.prev = _context.next) {\n            case 0:\n              if (!cE) {\n                _context.next = 4;\n                break;\n              }\n\n              return _context.abrupt(\"return\", {\n                changeEvent: cE\n              });\n\n            case 4:\n              _context.next = 6;\n              return _this7.getLocal(id);\n\n            case 6:\n              doc = _context.sent;\n              return _context.abrupt(\"return\", {\n                doc: doc\n              });\n\n            case 8:\n            case \"end\":\n              return _context.stop();\n          }\n        }\n      }, _callee);\n    }));\n\n    return function (_x) {\n      return _ref.apply(this, arguments);\n    };\n  }()), mergeMap( /*#__PURE__*/function () {\n    var _ref2 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee2(changeEventOrDoc) {\n      var cE, doc;\n      return _regeneratorRuntime.wrap(function _callee2$(_context2) {\n        while (1) {\n          switch (_context2.prev = _context2.next) {\n            case 0:\n              if (!changeEventOrDoc.changeEvent) {\n                _context2.next = 17;\n                break;\n              }\n\n              cE = changeEventOrDoc.changeEvent;\n\n              if (!(!cE.isLocal || cE.documentId !== id)) {\n                _context2.next = 6;\n                break;\n              }\n\n              return _context2.abrupt(\"return\", {\n                use: false\n              });\n\n            case 6:\n              if (!cE.rxDocument) {\n                _context2.next = 10;\n                break;\n              }\n\n              _context2.t0 = cE.rxDocument;\n              _context2.next = 13;\n              break;\n\n            case 10:\n              _context2.next = 12;\n              return _this7.getLocal(id);\n\n            case 12:\n              _context2.t0 = _context2.sent;\n\n            case 13:\n              doc = _context2.t0;\n              return _context2.abrupt(\"return\", {\n                use: true,\n                doc: doc\n              });\n\n            case 15:\n              _context2.next = 18;\n              break;\n\n            case 17:\n              return _context2.abrupt(\"return\", {\n                use: true,\n                doc: changeEventOrDoc.doc\n              });\n\n            case 18:\n            case \"end\":\n              return _context2.stop();\n          }\n        }\n      }, _callee2);\n    }));\n\n    return function (_x2) {\n      return _ref2.apply(this, arguments);\n    };\n  }()), filter(function (filterFlagged) {\n    return filterFlagged.use;\n  }), map(function (filterFlagged) {\n    return filterFlagged.doc;\n  }));\n}\n\nexport var rxdb = true;\nexport var prototypes = {\n  RxCollection: function RxCollection(proto) {\n    proto.insertLocal = insertLocal;\n    proto.upsertLocal = upsertLocal;\n    proto.getLocal = getLocal;\n    proto.getLocal$ = getLocal$;\n  },\n  RxDatabase: function RxDatabase(proto) {\n    proto.insertLocal = insertLocal;\n    proto.upsertLocal = upsertLocal;\n    proto.getLocal = getLocal;\n    proto.getLocal$ = getLocal$;\n  }\n};\nexport var overwritable = {};\nexport var RxDBLocalDocumentsPlugin = {\n  name: 'local-documents',\n  rxdb: rxdb,\n  prototypes: prototypes,\n  overwritable: overwritable\n};\n//# sourceMappingURL=local-documents.js.map"]},"metadata":{},"sourceType":"module"}